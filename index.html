<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<meta http-equiv="Content-Security-Policy"
  content="default-src 'self';
    img-src 'self' data:;
    style-src 'self' 'unsafe-inline';
    script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com;
    connect-src 'self';
    worker-src 'self' blob:;
    base-uri 'self';
    form-action 'self';
    frame-ancestors 'none'">
<title>AI Exam Coach</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéì</text></svg>">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.8.0/mammoth.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

/* ‚îÄ‚îÄ THEME VARIABLES ‚îÄ‚îÄ */
:root{
  --bg:#f0f2f5;--bg-card:#fff;--bg-sidebar:#1e1e2e;--bg-input:#f8f9fa;
  --text:#1a1a2e;--text-secondary:#6b7280;--text-sidebar:#cdd6f4;
  --primary:#6366f1;--primary-hover:#4f46e5;--primary-light:#eef2ff;--primary-glow:rgba(99,102,241,.15);
  --success:#10b981;--success-light:#ecfdf5;
  --danger:#ef4444;--danger-light:#fef2f2;
  --warning:#f59e0b;--warning-light:#fffbeb;
  --border:#e5e7eb;
  --shadow:0 1px 3px rgba(0,0,0,.08);--shadow-lg:0 10px 25px rgba(0,0,0,.1);
  --radius:12px;--radius-sm:8px;--transition:.2s ease;
  --header-h:56px;--mobile-tab-h:56px;
}
html.dark{
  --bg:#111827;--bg-card:#1f2937;--bg-sidebar:#0f172a;--bg-input:#374151;
  --text:#f3f4f6;--text-secondary:#9ca3af;--text-sidebar:#cbd5e1;
  --primary:#818cf8;--primary-hover:#6366f1;--primary-light:rgba(99,102,241,.15);--primary-glow:rgba(129,140,248,.2);
  --success:#34d399;--success-light:rgba(52,211,153,.12);
  --danger:#f87171;--danger-light:rgba(248,113,113,.12);
  --warning:#fbbf24;--warning-light:rgba(251,191,36,.12);
  --border:#374151;
  --shadow:0 1px 3px rgba(0,0,0,.3);--shadow-lg:0 10px 25px rgba(0,0,0,.4);
}
html{font-size:16px;scroll-behavior:smooth}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);line-height:1.6;height:100vh;height:100dvh;overflow:hidden}

/* ‚îÄ‚îÄ APP SHELL ‚îÄ‚îÄ */
.app{display:flex;height:100vh;height:100dvh;width:100vw;overflow:hidden}
.sidebar{width:300px;background:var(--bg-sidebar);color:var(--text-sidebar);display:flex;flex-direction:column;flex-shrink:0;transition:transform .3s ease;z-index:200;overflow:hidden}
.sidebar-header{padding:16px 20px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:space-between}
.sidebar-header h1{font-size:1.15rem;font-weight:700;color:#fff;display:flex;align-items:center;gap:10px;white-space:nowrap}
.sidebar-header h1 .logo{width:34px;height:34px;background:var(--primary);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0}
.sidebar-header-actions{display:flex;gap:4px}
.icon-btn{width:34px;height:34px;border:none;border-radius:var(--radius-sm);background:transparent;color:var(--text-sidebar);cursor:pointer;font-size:1.1rem;display:flex;align-items:center;justify-content:center;transition:background var(--transition)}
.icon-btn:hover{background:rgba(255,255,255,.1)}
.sidebar-body{flex:1;overflow-y:auto;padding:10px 0;-webkit-overflow-scrolling:touch}
.sidebar-footer{padding:12px 16px;border-top:1px solid rgba(255,255,255,.08);font-size:.72rem;color:rgba(255,255,255,.35);text-align:center}
.sb-section{margin-bottom:12px;padding:0 12px}
.sb-section-title{font-size:.68rem;text-transform:uppercase;letter-spacing:1.2px;color:rgba(255,255,255,.3);padding:8px 0 4px;font-weight:600}
.sb-btn{width:100%;text-align:left;padding:9px 12px;border:none;background:transparent;color:var(--text-sidebar);border-radius:var(--radius-sm);cursor:pointer;font-size:.85rem;display:flex;align-items:center;gap:10px;transition:background var(--transition)}
.sb-btn:hover{background:rgba(255,255,255,.08)}
.sb-btn .sb-icon{width:20px;text-align:center;font-size:1rem}
.lang-select{width:100%;padding:8px 10px;border-radius:var(--radius-sm);border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.06);color:#fff;font-size:.8rem;outline:none;cursor:pointer}
.lang-select option{background:var(--bg-sidebar);color:#fff}
.qcount-row{display:flex;align-items:center;gap:8px;padding:4px 0}
.qcount-row label{font-size:.78rem;color:rgba(255,255,255,.55);white-space:nowrap}
.qcount-select{padding:5px 8px;border-radius:var(--radius-sm);border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.06);color:#fff;font-size:.8rem;outline:none;cursor:pointer}
.qcount-select option{background:var(--bg-sidebar);color:#fff}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.main{flex:1;display:flex;flex-direction:column;min-width:0;overflow:hidden}
.main-header{height:var(--header-h);padding:0 16px;background:var(--bg-card);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-shrink:0}
.main-header .mode-title{font-weight:600;font-size:.95rem}
.main-header .mode-desc{font-size:.78rem;color:var(--text-secondary)}
.header-spacer{flex:1}
.header-btn{height:36px;padding:0 14px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--bg-card);color:var(--text);font-size:.8rem;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:6px;transition:all var(--transition);white-space:nowrap}
.header-btn:hover{border-color:var(--primary);color:var(--primary);background:var(--primary-light)}
.header-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
.hamburger{display:none;background:none;border:none;font-size:1.4rem;cursor:pointer;padding:4px 8px;border-radius:6px;color:var(--text)}
.hamburger:hover{background:var(--bg-input)}

/* ‚îÄ‚îÄ WORKSPACE: flexbox instead of grid ‚îÄ‚îÄ */
.workspace{display:flex;flex:1;min-height:0;overflow:hidden}
.chat-column{display:flex;flex-direction:column;flex:1;min-width:0;min-height:0;overflow:hidden;background:var(--bg)}
.chat-area{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:14px;-webkit-overflow-scrolling:touch;scroll-behavior:smooth;overscroll-behavior:contain}
.chat-area::-webkit-scrollbar{width:5px}
.chat-area::-webkit-scrollbar-thumb{background:rgba(0,0,0,.12);border-radius:3px}

.practice-panel{width:420px;flex-shrink:0;display:flex;flex-direction:column;background:var(--bg-card);border-left:1px solid var(--border);transition:width .3s ease,opacity .2s ease;overflow:hidden}
.practice-panel.collapsed{width:0;opacity:0;border-left:none;pointer-events:none}
.practice-header{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:8px;flex-shrink:0}
.practice-title{font-size:.88rem;font-weight:700}
.practice-subtitle{font-size:.72rem;color:var(--text-secondary)}
.practice-body{padding:12px;overflow-y:auto;display:flex;flex-direction:column;gap:10px;flex:1;min-height:0;-webkit-overflow-scrolling:touch;overscroll-behavior:contain}
.practice-empty{border:1px dashed var(--border);border-radius:var(--radius);padding:16px;color:var(--text-secondary);font-size:.82rem;line-height:1.6;background:var(--bg-input)}
.practice-chip{font-size:.66rem;text-transform:uppercase;letter-spacing:.6px;padding:3px 8px;border-radius:20px;background:var(--primary-light);color:var(--primary);font-weight:600}

/* ‚îÄ‚îÄ MESSAGES ‚îÄ‚îÄ */
.msg{display:flex;gap:10px;max-width:min(85%,700px);animation:msgIn .3s ease}
.msg.user{align-self:flex-end;flex-direction:row-reverse}
.msg.bot{align-self:flex-start}
.msg-avatar{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.95rem;flex-shrink:0}
.msg.bot .msg-avatar{background:var(--primary-light);color:var(--primary)}
.msg.user .msg-avatar{background:var(--primary-light);color:var(--primary)}
.msg-bubble{padding:10px 14px;border-radius:var(--radius);font-size:.88rem;line-height:1.65;word-wrap:break-word;overflow-wrap:break-word;max-width:100%}
.msg.bot .msg-bubble{background:var(--bg-card);border:1px solid var(--border);border-top-left-radius:4px;box-shadow:var(--shadow)}
.msg.user .msg-bubble{background:var(--primary);color:#fff;border-top-right-radius:4px}
.msg-bubble p{margin-bottom:8px}.msg-bubble p:last-child{margin-bottom:0}
.msg-bubble code{background:rgba(0,0,0,.06);padding:2px 5px;border-radius:4px;font-family:'Cascadia Code','Fira Code',monospace;font-size:.8rem}
.msg.user .msg-bubble code{background:rgba(255,255,255,.2)}
.msg-bubble pre{background:#1e1e2e;color:#cdd6f4;padding:12px;border-radius:var(--radius-sm);overflow-x:auto;margin:8px 0;font-size:.8rem;line-height:1.5;position:relative}
.msg-bubble pre code{background:transparent;padding:0;color:inherit}
.msg-bubble ul,.msg-bubble ol{padding-left:18px;margin:8px 0}.msg-bubble li{margin-bottom:4px}
.msg-bubble strong{font-weight:600}
.msg-bubble h3,.msg-bubble h4{margin:12px 0 6px;font-weight:600}
.msg-bubble h3{font-size:.98rem}.msg-bubble h4{font-size:.88rem}
.msg-bubble blockquote{border-left:3px solid var(--primary);padding-left:12px;margin:8px 0;color:var(--text-secondary);font-style:italic}
.msg-bubble hr{border:none;border-top:1px solid var(--border);margin:12px 0}
.msg.user .msg-bubble pre{background:rgba(0,0,0,.3)}
@keyframes msgIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.typing{display:flex;gap:4px;padding:4px 0}
.typing span{width:7px;height:7px;background:var(--text-secondary);border-radius:50%;animation:bounce 1.4s infinite both;opacity:.4}
.typing span:nth-child(2){animation-delay:.2s}.typing span:nth-child(3){animation-delay:.4s}
@keyframes bounce{0%,80%,100%{transform:scale(.6)}40%{transform:scale(1);opacity:1}}

/* ‚îÄ‚îÄ QUIZ ‚îÄ‚îÄ */
.quiz-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin:4px 0;box-shadow:var(--shadow);animation:msgIn .3s ease}
.quiz-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:6px}
.quiz-card-header .badge{font-size:.68rem;padding:3px 9px;border-radius:20px;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
.badge-single{background:var(--primary-light);color:var(--primary)}
.badge-multi{background:var(--warning-light);color:#b45309}
.badge-coding{background:var(--success-light);color:var(--success)}
.quiz-question{font-weight:600;font-size:.92rem;margin-bottom:14px;line-height:1.5}
.quiz-option{display:flex;align-items:flex-start;gap:10px;padding:9px 12px;border:2px solid var(--border);border-radius:var(--radius-sm);margin-bottom:7px;cursor:pointer;transition:all var(--transition);font-size:.85rem;user-select:none;-webkit-tap-highlight-color:transparent}
.quiz-option:hover:not(.disabled){border-color:var(--primary);background:var(--primary-light)}
.quiz-option.selected{border-color:var(--primary);background:var(--primary-light)}
.quiz-option.correct{border-color:var(--success);background:var(--success-light)}
.quiz-option.incorrect{border-color:var(--danger);background:var(--danger-light)}
.quiz-option.disabled{cursor:default;opacity:.7}.quiz-option.disabled.correct{opacity:1}
.quiz-option .marker{width:22px;height:22px;border:2px solid var(--border);border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:.7rem;transition:all var(--transition)}
.quiz-option.multi .marker{border-radius:4px}
.quiz-option.selected .marker{border-color:var(--primary);background:var(--primary);color:#fff}
.quiz-option.correct .marker{border-color:var(--success);background:var(--success);color:#fff}
.quiz-option.incorrect .marker{border-color:var(--danger);background:var(--danger);color:#fff}
.quiz-explanation{margin-top:12px;padding:10px 12px;border-radius:var(--radius-sm);font-size:.82rem;line-height:1.6}
.quiz-explanation.correct-expl{background:var(--success-light);border-left:3px solid var(--success)}
.quiz-explanation.incorrect-expl{background:var(--danger-light);border-left:3px solid var(--danger)}
.quiz-explanation.partial-expl{background:var(--warning-light);border-left:3px solid var(--warning)}
.quiz-btn{padding:8px 18px;border:none;border-radius:var(--radius-sm);font-size:.83rem;font-weight:600;cursor:pointer;transition:all var(--transition);-webkit-tap-highlight-color:transparent}
.quiz-btn-primary{background:var(--primary);color:#fff}.quiz-btn-primary:hover{background:var(--primary-hover)}
.quiz-btn-secondary{background:var(--bg-input);color:var(--text);border:1px solid var(--border)}.quiz-btn-secondary:hover{background:var(--border)}
.quiz-actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
.quiz-progress{height:4px;border-radius:2px;background:var(--border);margin:4px 0 8px;overflow:hidden}
.quiz-progress-fill{height:100%;background:var(--primary);border-radius:2px;transition:width .4s ease}

/* ‚îÄ‚îÄ SCORE ‚îÄ‚îÄ */
.score-card{background:linear-gradient(135deg,var(--primary),#8b5cf6);color:#fff;border-radius:var(--radius);padding:20px;text-align:center;margin:4px 0;box-shadow:var(--shadow-lg);animation:msgIn .3s ease}
.score-card h3{font-size:1.2rem;margin-bottom:4px}
.score-card .score-big{font-size:2.6rem;font-weight:800;margin:10px 0}
.score-card .score-details{display:flex;justify-content:center;gap:20px;margin-top:10px;font-size:.82rem;opacity:.9;flex-wrap:wrap}
.score-card .score-detail{display:flex;flex-direction:column;align-items:center;gap:2px}
.score-card .score-detail strong{font-size:1.1rem}

/* ‚îÄ‚îÄ CODING ‚îÄ‚îÄ */
.problem-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin:4px 0;box-shadow:var(--shadow);animation:msgIn .3s ease}
.problem-card h4{display:flex;align-items:center;gap:8px;margin-bottom:10px;font-size:.95rem;flex-wrap:wrap}
.problem-card .difficulty-tag{font-size:.68rem;padding:2px 8px;border-radius:10px;font-weight:600}
.diff-easy{background:var(--success-light);color:var(--success)}
.diff-medium{background:var(--warning-light);color:#b45309}
.diff-hard{background:var(--danger-light);color:var(--danger)}
.problem-section{margin-bottom:12px}
.problem-section h5{font-size:.8rem;font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px}
.problem-section p,.problem-section ul,.problem-section ol{font-size:.85rem}
.problem-section ul,.problem-section ol{padding-left:18px}
.problem-hint{background:var(--warning-light);border:1px solid rgba(253,224,71,.4);border-radius:var(--radius-sm);padding:10px 12px;font-size:.82rem;display:none;margin-top:8px}
.problem-hint.visible{display:block}
.hint-toggle{font-size:.78rem;color:var(--primary);cursor:pointer;background:none;border:none;font-weight:600;padding:0}
.hint-toggle:hover{text-decoration:underline}
.problem-topics{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px}
.problem-topic-tag{background:var(--primary-light);color:var(--primary);padding:2px 8px;border-radius:10px;font-size:.72rem}

/* ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ */
.input-area{padding:12px 16px;background:var(--bg-card);border-top:1px solid var(--border);flex-shrink:0;z-index:8;box-shadow:0 -4px 16px rgba(0,0,0,.04)}
.input-row{display:flex;gap:8px;align-items:flex-end;max-width:900px;margin:0 auto}
.input-box{flex:1;position:relative}
.input-box textarea{width:100%;padding:10px 14px;border:2px solid var(--border);border-radius:var(--radius);font-size:.88rem;font-family:inherit;resize:none;outline:none;transition:border var(--transition);min-height:44px;max-height:180px;line-height:1.5;background:var(--bg-input);color:var(--text)}
.input-box textarea:focus{border-color:var(--primary)}
.input-box textarea::placeholder{color:var(--text-secondary)}
.send-btn{width:44px;height:44px;border-radius:var(--radius);border:none;background:var(--primary);color:#fff;font-size:1.1rem;cursor:pointer;transition:all var(--transition);display:flex;align-items:center;justify-content:center;flex-shrink:0;-webkit-tap-highlight-color:transparent}
.send-btn:hover{background:var(--primary-hover);transform:scale(1.05)}
.send-btn:disabled{background:var(--border);color:var(--text-secondary);cursor:not-allowed;transform:none}
.input-hint{font-size:.7rem;color:var(--text-secondary);margin-top:5px;text-align:center}

/* ‚îÄ‚îÄ WELCOME ‚îÄ‚îÄ */
.welcome{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;text-align:center;padding:30px 16px;overflow-y:auto}
.welcome-icon{font-size:3.5rem;margin-bottom:12px}
.welcome h2{font-size:clamp(1.2rem,3vw,1.6rem);font-weight:700;margin-bottom:8px}
.welcome p{color:var(--text-secondary);max-width:480px;margin-bottom:20px;font-size:.9rem}
.feature-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;max-width:680px;width:100%;margin-bottom:20px}
.feature-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:14px;text-align:left;transition:all var(--transition);cursor:pointer;-webkit-tap-highlight-color:transparent}
.feature-card:hover{border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-glow)}
.feature-card .fc-icon{font-size:1.3rem;margin-bottom:6px}
.feature-card h4{font-size:.82rem;font-weight:600;margin-bottom:3px}
.feature-card p{font-size:.74rem;color:var(--text-secondary)}
.quick-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
.quick-action-btn{padding:8px 14px;border-radius:20px;border:1px solid var(--border);background:var(--bg-card);font-size:.78rem;cursor:pointer;transition:all var(--transition);color:var(--text);display:flex;align-items:center;gap:6px;-webkit-tap-highlight-color:transparent}
.quick-action-btn:hover{border-color:var(--primary);background:var(--primary-light);color:var(--primary)}

/* ‚îÄ‚îÄ SIDEBAR WIDGETS ‚îÄ‚îÄ */
.stats-bar{display:flex;gap:12px;flex-wrap:wrap}
.stat-item{font-size:.73rem;color:rgba(255,255,255,.55);display:flex;align-items:center;gap:4px}
.stat-item strong{color:rgba(255,255,255,.85)}
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:199}
.sidebar-overlay.active{display:block}
.session-item{padding:7px 10px;border-radius:var(--radius-sm);cursor:pointer;font-size:.78rem;color:rgba(255,255,255,.55);transition:background var(--transition);display:flex;align-items:center;gap:8px;margin-bottom:2px}
.session-item:hover{background:rgba(255,255,255,.06);color:rgba(255,255,255,.9)}
.session-item.active{background:rgba(99,102,241,.2);color:#fff}
.session-item .session-icon{font-size:.85rem}
.session-item .session-text{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
.session-item .session-delete{opacity:0;font-size:.75rem;background:none;border:none;color:rgba(255,255,255,.4);cursor:pointer;padding:2px 4px;border-radius:4px}
.session-item:hover .session-delete{opacity:1}
.session-item .session-delete:hover{color:var(--danger);background:rgba(239,68,68,.15)}
.material-textarea{width:100%;height:80px;padding:8px 10px;border-radius:var(--radius-sm);border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.06);color:#fff;font-size:.76rem;outline:none;resize:vertical;font-family:inherit;transition:border var(--transition)}
.material-textarea:focus{border-color:var(--primary)}
.material-textarea::placeholder{color:rgba(255,255,255,.22)}
.new-session-btn{width:100%;padding:9px;border-radius:var(--radius-sm);border:1px dashed rgba(255,255,255,.15);background:transparent;color:rgba(255,255,255,.6);cursor:pointer;font-size:.8rem;display:flex;align-items:center;justify-content:center;gap:6px;transition:all var(--transition);margin-bottom:6px}
.new-session-btn:hover{border-color:var(--primary);color:var(--primary);background:rgba(99,102,241,.08)}
.export-btn{width:100%;padding:7px;border-radius:var(--radius-sm);border:1px solid rgba(255,255,255,.1);background:transparent;color:rgba(255,255,255,.45);cursor:pointer;font-size:.76rem;display:flex;align-items:center;justify-content:center;gap:6px;transition:all var(--transition)}
.export-btn:hover{border-color:rgba(255,255,255,.3);color:rgba(255,255,255,.8)}
.file-upload-row{display:flex;gap:6px;margin-bottom:6px;align-items:center}
.file-upload-btn{flex:1;padding:8px 10px;border-radius:var(--radius-sm);border:1px dashed rgba(255,255,255,.2);background:rgba(99,102,241,.06);color:rgba(255,255,255,.65);cursor:pointer;font-size:.76rem;text-align:center;transition:all var(--transition);display:flex;align-items:center;justify-content:center;gap:6px}
.file-upload-btn:hover{border-color:var(--primary);color:var(--primary);background:rgba(99,102,241,.12)}
.file-upload-btn.loading{pointer-events:none;opacity:.6}
.file-clear-btn{padding:8px 10px;border-radius:var(--radius-sm);border:1px solid rgba(255,255,255,.1);background:transparent;color:rgba(255,255,255,.4);cursor:pointer;font-size:.76rem;transition:all var(--transition)}
.file-clear-btn:hover{border-color:var(--danger);color:var(--danger);background:rgba(239,68,68,.08)}
.file-info{margin-bottom:5px;font-size:.7rem;color:rgba(255,255,255,.45);line-height:1.4}
.file-info .file-name{color:var(--primary);font-weight:600}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast{position:fixed;top:16px;right:16px;padding:10px 18px;border-radius:var(--radius-sm);color:#fff;font-size:.82rem;z-index:9000;animation:toastIn .3s ease;box-shadow:var(--shadow-lg);max-width:380px}
.toast.success{background:var(--success)}.toast.error{background:var(--danger)}.toast.info{background:var(--primary)}
@keyframes toastIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}

/* ‚îÄ‚îÄ MOBILE TAB BAR ‚îÄ‚îÄ */
.mobile-tabs{display:none;height:var(--mobile-tab-h);background:var(--bg-card);border-top:1px solid var(--border);flex-shrink:0}
.mobile-tabs button{flex:1;border:none;background:transparent;color:var(--text-secondary);font-size:.72rem;font-weight:600;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;transition:color var(--transition);-webkit-tap-highlight-color:transparent;padding:4px}
.mobile-tabs button .tab-icon{font-size:1.2rem}
.mobile-tabs button.active{color:var(--primary)}

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media(max-width:1100px){
  .practice-panel{width:340px}
}
@media(max-width:900px){
  .practice-panel{width:300px}
}
@media(max-width:768px){
  .sidebar{position:fixed;left:0;top:0;bottom:0;transform:translateX(-100%);width:280px}
  .sidebar.open{transform:translateX(0)}
  .hamburger{display:block}
  .workspace{flex-direction:column;position:relative}
  .practice-panel{width:100%;border-left:none;border-top:1px solid var(--border);position:absolute;top:0;left:0;right:0;bottom:0;z-index:10;background:var(--bg-card)}
  .practice-panel.collapsed{display:none}
  .mobile-tabs{display:flex}
  .msg{max-width:92%}
  .feature-grid{grid-template-columns:repeat(2,1fr)}
  .input-hint{display:none}
  .header-btn.practice-toggle{display:none}
  .main-header .mode-desc{display:none}
  .input-area{padding-bottom:calc(12px + env(safe-area-inset-bottom,0px))}
  .mobile-tabs{padding-bottom:env(safe-area-inset-bottom,0px)}
  .quiz-option{padding:12px 14px}
  .quiz-btn{padding:12px 20px}
}
@media(max-width:400px){
  .feature-grid{grid-template-columns:1fr}
  .chat-area{padding:14px 10px}
  .input-area{padding:10px 10px}
}
.sidebar-body::-webkit-scrollbar{width:4px}
.sidebar-body::-webkit-scrollbar-thumb{background:rgba(255,255,255,.08);border-radius:2px}
.practice-body::-webkit-scrollbar{width:4px}
.practice-body::-webkit-scrollbar-thumb{background:rgba(0,0,0,.1);border-radius:2px}
</style>
</head>
<body>
<div class="app">
  <!-- ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h1><span class="logo">üéì</span>AI Exam Coach</h1>
      <div class="sidebar-header-actions">
        <button class="icon-btn" onclick="toggleDarkMode()" title="Toggle dark mode" id="darkModeBtn">üåô</button>
        <button class="icon-btn sidebar-close-btn" onclick="closeSidebar()" title="Close">‚úï</button>
      </div>
    </div>
    <div class="sidebar-body">
      <div class="sb-section">
        <button class="new-session-btn" onclick="newSession()">Ôºã New Session</button>
      </div>

      <div class="sb-section">
        <div class="sb-section-title">üåê Language</div>
        <select class="lang-select" id="langSelect" onchange="onLangChange()">
          <option value="en">English</option>
          <option value="ru">–†—É—Å—Å–∫–∏–π</option>
          <option value="kk">“ö–∞–∑–∞“õ—à–∞</option>
        </select>
      </div>

      <div class="sb-section">
        <div class="sb-section-title">üìö Study Material</div>
        <div class="file-upload-row">
          <label class="file-upload-btn" id="fileUploadBtn">
            üìé Upload .pdf / .docx / .xlsx
            <input type="file" id="fileInput" accept=".pdf,.docx,.xlsx,.xls" style="display:none" onchange="handleFileUpload(event)">
          </label>
          <button class="file-clear-btn" onclick="clearUploadedFile()" title="Clear">‚úï</button>
        </div>
        <div class="file-info" id="fileInfo"></div>
        <textarea class="material-textarea" id="materialInput" placeholder="Paste notes here, or upload a file above‚Ä¶" oninput="saveMaterial()"></textarea>
      </div>

      <div class="sb-section">
        <div class="sb-section-title">‚ö° Quick Tools</div>
        <div class="qcount-row">
          <label>Questions:</label>
          <select class="qcount-select" id="qcountSelect" onchange="onQCountChange()">
            <option value="3">3</option>
            <option value="5" selected>5</option>
            <option value="10">10</option>
            <option value="15">15</option>
            <option value="20">20</option>
          </select>
        </div>
        <button class="sb-btn" onclick="quickCommand('/quiz')"><span class="sb-icon">üìù</span>Single-Answer Quiz</button>
        <button class="sb-btn" onclick="quickCommand('/multiquiz')"><span class="sb-icon">‚òëÔ∏è</span>Multi-Answer Quiz</button>
        <button class="sb-btn" onclick="quickCommand('/coding')"><span class="sb-icon">üíª</span>Coding Problem</button>
        <button class="sb-btn" onclick="quickCommand('/explain')"><span class="sb-icon">üí°</span>Explain Topic</button>
        <button class="sb-btn" onclick="quickCommand('/flashcards')"><span class="sb-icon">üÉè</span>Flashcards</button>
        <button class="sb-btn" onclick="quickCommand('/summary')"><span class="sb-icon">üìã</span>Summarize Material</button>
      </div>

      <div class="sb-section">
        <div class="sb-section-title">üìä Stats</div>
        <div class="stats-bar">
          <div class="stat-item">üìù <strong id="statQuizzes">0</strong></div>
          <div class="stat-item">‚úÖ <strong id="statCorrect">0</strong></div>
          <div class="stat-item">‚ùå <strong id="statWrong">0</strong></div>
          <div class="stat-item">üíª <strong id="statProblems">0</strong></div>
        </div>
      </div>

      <div class="sb-section">
        <div class="sb-section-title">üìÇ History</div>
        <div id="sessionList"></div>
      </div>

      <div class="sb-section">
        <button class="export-btn" onclick="exportSession()">üì• Export as Markdown</button>
      </div>
    </div>
    <div class="sidebar-footer">AI Exam Coach ¬∑ Powered by DeepSeek AI ¬∑ Deployed on Netlify</div>
  </aside>

  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

  <!-- ‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê -->
  <div class="main">
    <div class="main-header">
      <button class="hamburger" onclick="toggleSidebar()">‚ò∞</button>
      <div><div class="mode-title">AI Exam Coach</div><div class="mode-desc">Your personal exam preparation assistant</div></div>
      <div class="header-spacer"></div>
      <button class="header-btn practice-toggle" id="practiceToggleBtn" onclick="togglePractice()">
        <span id="practiceToggleIcon">üìã</span> <span id="practiceToggleText">Practice</span>
      </button>
    </div>

    <div class="workspace">
      <div class="chat-column" id="chatColumn">
        <div class="chat-area" id="chatArea">
          <div class="welcome" id="welcomeScreen">
            <div class="welcome-icon">üéì</div>
            <h2>Welcome to AI Exam Coach</h2>
            <p>Upload your study material or tell me a topic. I'll generate quizzes, coding problems, flashcards, and explanations.</p>
            <div class="feature-grid">
              <div class="feature-card" onclick="quickCommand('/quiz')"><div class="fc-icon">üìù</div><h4>Quiz</h4><p>Single-answer multiple choice</p></div>
              <div class="feature-card" onclick="quickCommand('/multiquiz')"><div class="fc-icon">‚òëÔ∏è</div><h4>Multi-Quiz</h4><p>Multiple correct answers</p></div>
              <div class="feature-card" onclick="quickCommand('/coding')"><div class="fc-icon">üíª</div><h4>Coding</h4><p>Programming exercises</p></div>
              <div class="feature-card" onclick="quickCommand('/explain')"><div class="fc-icon">üí°</div><h4>Explain</h4><p>Concept explanations</p></div>
              <div class="feature-card" onclick="quickCommand('/flashcards')"><div class="fc-icon">üÉè</div><h4>Flashcards</h4><p>Term &amp; definition cards</p></div>
              <div class="feature-card" onclick="quickCommand('/summary')"><div class="fc-icon">üìã</div><h4>Summary</h4><p>Summarize your material</p></div>
            </div>
            <div class="quick-actions">
              <button class="quick-action-btn" onclick="quickSend('/quiz Generate 5 questions about data structures')">üöÄ Sample quiz</button>
              <button class="quick-action-btn" onclick="quickSend('/coding Create a linked list problem')">üíª Sample coding</button>
            </div>
          </div>
        </div>
        <div class="input-area">
          <div class="input-row">
            <div class="input-box">
              <textarea id="userInput" rows="1" placeholder="Ask anything, or /quiz, /coding, /explain‚Ä¶" onkeydown="handleInputKey(event)" oninput="autoResize(this)"></textarea>
            </div>
            <button class="send-btn" id="sendBtn" onclick="sendMessage()" title="Send">‚ñ∂</button>
          </div>
          <div class="input-hint">Enter = send ¬∑ Shift+Enter = new line ¬∑ /quiz ¬∑ /multiquiz ¬∑ /coding ¬∑ /explain ¬∑ /flashcards ¬∑ /summary</div>
        </div>
      </div>

      <aside class="practice-panel" id="practicePanel">
        <div class="practice-header">
          <div><div class="practice-title">Practice Workspace</div><div class="practice-subtitle">Quiz / coding / flashcards</div></div>
          <button class="quiz-btn quiz-btn-secondary" onclick="clearPractice()">Clear</button>
        </div>
        <div class="practice-body" id="practiceBody">
          <div class="practice-empty">No active practice yet. Use <strong>/quiz</strong>, <strong>/coding</strong>, or <strong>/flashcards</strong>.</div>
        </div>
      </aside>
    </div>

    <div class="mobile-tabs" id="mobileTabs">
      <button class="active" id="tabChat" onclick="switchMobileTab('chat')"><span class="tab-icon">üí¨</span>Chat</button>
      <button id="tabPractice" onclick="switchMobileTab('practice')"><span class="tab-icon">üìã</span>Practice</button>
    </div>
  </div>
</div>

<script>
const PROXY_ENDPOINT='/.netlify/functions/deepseek-proxy';
const DEEPSEEK_MODEL='deepseek-chat';

const state={sessions:[],currentSessionId:null,language:'en',material:'',uploadedFileName:'',isGenerating:false,stats:{quizzes:0,correct:0,wrong:0,problems:0},darkMode:false,practiceOpen:true,questionCount:5,mobileTab:'chat'};

const i18n={
  en:{placeholder:'Ask anything, or /quiz, /coding, /explain‚Ä¶',correct:'‚úÖ Correct!',incorrect:'‚ùå Incorrect.',partial:'‚ö†Ô∏è Partially correct.',selectAll:'Select all that apply, then click Submit.',selectOne:'Select one answer, then click Submit.',submitAnswer:'Submit Answer',quizComplete:'Quiz Complete!',hint:'üí° Show Hint',hideHint:'üí° Hide Hint',exportTitle:'AI Exam Coach ‚Äî Session Export',selectFirst:'Please select an answer first.',excellent:'Excellent work!',great:'Great job! Almost perfect!',good:'Good effort! Review the mistakes.',keepStudying:'Keep studying, you\'ll get there!',accuracy:'Accuracy',correctLabel:'Correct',wrongLabel:'Wrong',parseError:'Could not parse AI response. Retrying‚Ä¶',uploadSuccess:'File loaded!',uploadFail:'Failed to parse file.',uploading:'Parsing file‚Ä¶',proxyError:'‚ö†Ô∏è Could not reach AI server. Deploy on Netlify or run "npx netlify dev".'},
  ru:{placeholder:'–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å: /quiz, /coding, /explain‚Ä¶',correct:'‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!',incorrect:'‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ.',partial:'‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ.',selectAll:'–í—ã–±–µ—Ä–∏—Ç–µ –≤—Å–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏ –Ω–∞–∂–º–∏—Ç–µ –û—Ç–≤–µ—Ç–∏—Ç—å.',selectOne:'–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –æ—Ç–≤–µ—Ç –∏ –Ω–∞–∂–º–∏—Ç–µ –û—Ç–≤–µ—Ç–∏—Ç—å.',submitAnswer:'–û—Ç–≤–µ—Ç–∏—Ç—å',quizComplete:'–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!',hint:'üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞',hideHint:'üí° –°–∫—Ä—ã—Ç—å',exportTitle:'AI Exam Coach ‚Äî –≠–∫—Å–ø–æ—Ä—Ç',selectFirst:'–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç.',excellent:'–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!',great:'–ó–¥–æ—Ä–æ–≤–æ! –ü–æ—á—Ç–∏ –∏–¥–µ–∞–ª—å–Ω–æ!',good:'–•–æ—Ä–æ—à–æ! –†–∞–∑–±–µ—Ä–∏—Ç–µ –æ—à–∏–±–∫–∏.',keepStudying:'–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —É—á–∏—Ç—å—Å—è!',accuracy:'–¢–æ—á–Ω–æ—Å—Ç—å',correctLabel:'–í–µ—Ä–Ω–æ',wrongLabel:'–û—à–∏–±–∫–∏',parseError:'–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –æ—Ç–≤–µ—Ç. –ü–æ–≤—Ç–æ—Ä‚Ä¶',uploadSuccess:'–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω!',uploadFail:'–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª.',uploading:'–ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞‚Ä¶',proxyError:'‚ö†Ô∏è –ù–µ—Ç —Å–≤—è–∑–∏ —Å –ò–ò. –†–∞–∑–≤–µ—Ä–Ω–∏—Ç–µ –Ω–∞ Netlify –∏–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ "npx netlify dev".'},
  kk:{placeholder:'–°“±—Ä–∞“õ “õ–æ–π—ã“£—ã–∑: /quiz, /coding, /explain‚Ä¶',correct:'‚úÖ –î“±—Ä—ã—Å!',incorrect:'‚ùå “ö–∞—Ç–µ.',partial:'‚ö†Ô∏è –ñ–∞—Ä—Ç—ã–ª–∞–π –¥“±—Ä—ã—Å.',selectAll:'–ë–∞—Ä–ª—ã“õ –¥“±—Ä—ã—Å –Ω“±—Å“õ–∞–ª–∞—Ä–¥—ã —Ç–∞“£–¥–∞–ø, –ñ—ñ–±–µ—Ä—É –±–∞—Å—ã“£—ã–∑.',selectOne:'–ë—ñ—Ä –∂–∞—É–∞–ø—Ç—ã —Ç–∞“£–¥–∞–ø, –ñ—ñ–±–µ—Ä—É –±–∞—Å—ã“£—ã–∑.',submitAnswer:'–ñ—ñ–±–µ—Ä—É',quizComplete:'–¢–µ—Å—Ç –∞—è“õ—Ç–∞–ª–¥—ã!',hint:'üí° –ö–µ“£–µ—Å',hideHint:'üí° –ñ–∞—Å—ã—Ä—É',exportTitle:'AI Exam Coach ‚Äî –≠–∫—Å–ø–æ—Ä—Ç',selectFirst:'–ê–ª–¥—ã–º–µ–Ω –∂–∞—É–∞–ø —Ç–∞“£–¥–∞“£—ã–∑.',excellent:'–ö–µ—Ä–µ–º–µ—Ç!',great:'”®—Ç–µ –∂–∞“õ—Å—ã!',good:'–ñ–∞“õ—Å—ã! “ö–∞—Ç–µ–ª–µ—Ä–¥—ñ “õ–∞–π—Ç–∞–ª–∞“£—ã–∑.',keepStudying:'–û“õ—É–¥—ã –∂–∞–ª“ì–∞—Å—Ç—ã—Ä—ã“£—ã–∑!',accuracy:'–î”ô–ª–¥—ñ–∫',correctLabel:'–î“±—Ä—ã—Å',wrongLabel:'“ö–∞—Ç–µ',parseError:'–ò–ò –∂–∞—É–∞–±—ã–Ω —Ç–∞–ª–¥–∞—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã. “ö–∞–π—Ç–∞‚Ä¶',uploadSuccess:'–§–∞–π–ª –∂“Ø–∫—Ç–µ–ª–¥—ñ!',uploadFail:'–§–∞–π–ª–¥—ã –æ“õ—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.',uploading:'–§–∞–π–ª –æ“õ—ã–ª—É–¥–∞‚Ä¶',proxyError:'‚ö†Ô∏è –ò–ò —Å–µ—Ä–≤–µ—Ä—ñ–Ω–µ “õ–æ—Å—ã–ª—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.'}
};
function t(k){return(i18n[state.language]&&i18n[state.language][k])||i18n.en[k]||k}

// ‚îÄ‚îÄ PERSISTENCE ‚îÄ‚îÄ
function saveState(){try{localStorage.setItem('examCoachState',JSON.stringify({sessions:state.sessions,currentSessionId:state.currentSessionId,language:state.language,material:state.material,uploadedFileName:state.uploadedFileName,stats:state.stats,darkMode:state.darkMode,practiceOpen:state.practiceOpen,questionCount:state.questionCount}))}catch(e){}}
function loadState(){try{const s=JSON.parse(localStorage.getItem('examCoachState')||'{}');if(s.language)state.language=s.language;if(s.material)state.material=s.material;if(s.uploadedFileName)state.uploadedFileName=s.uploadedFileName;if(s.sessions)state.sessions=s.sessions;if(s.currentSessionId)state.currentSessionId=s.currentSessionId;if(s.stats)state.stats=s.stats;if(typeof s.darkMode==='boolean')state.darkMode=s.darkMode;if(typeof s.practiceOpen==='boolean')state.practiceOpen=s.practiceOpen;if(s.questionCount)state.questionCount=s.questionCount}catch(e){}}

// ‚îÄ‚îÄ SESSIONS ‚îÄ‚îÄ
function getCurrentSession(){return state.sessions.find(s=>s.id===state.currentSessionId)}
function newSession(){const session={id:Date.now().toString(36)+Math.random().toString(36).slice(2,6),title:'New Session',messages:[],activeStudyMsgIdx:null,created:Date.now()};state.sessions.unshift(session);state.currentSessionId=session.id;saveState();renderSessionList();renderChat();renderPracticePane();closeSidebar()}
function switchSession(id){state.currentSessionId=id;saveState();renderSessionList();renderChat();renderPracticePane();closeSidebar()}
function deleteSession(id,evt){evt.stopPropagation();state.sessions=state.sessions.filter(s=>s.id!==id);if(state.currentSessionId===id)state.currentSessionId=state.sessions.length?state.sessions[0].id:null;saveState();renderSessionList();renderChat();renderPracticePane()}
function renderSessionList(){const el=document.getElementById('sessionList');if(!el)return;el.innerHTML=state.sessions.map(s=>`<div class="session-item ${s.id===state.currentSessionId?'active':''}" onclick="switchSession('${s.id}')"><span class="session-icon">üí¨</span><span class="session-text">${escHtml(s.title)}</span><button class="session-delete" onclick="deleteSession('${s.id}',event)" title="Delete">‚úï</button></div>`).join('')}
function updateSessionTitle(session){const first=session.messages.find(m=>m.role==='user');if(first)session.title=first.content.slice(0,55)+(first.content.length>55?'‚Ä¶':'')}

// ‚îÄ‚îÄ HTML HELPERS ‚îÄ‚îÄ
function escHtml(s){if(!s)return'';const d=document.createElement('div');d.textContent=String(s);return d.innerHTML}
function renderMarkdown(text){if(!text)return'';let h=escHtml(text);h=h.replace(/```(\w*)\n([\s\S]*?)```/g,(_,l,c)=>`<pre><code>${c.trim()}</code></pre>`);h=h.replace(/`([^`]+)`/g,'<code>$1</code>');h=h.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');h=h.replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g,'<em>$1</em>');h=h.replace(/^#### (.+)$/gm,'<h4>$1</h4>');h=h.replace(/^### (.+)$/gm,'<h3>$1</h3>');h=h.replace(/^## (.+)$/gm,'<h3>$1</h3>');h=h.replace(/^---$/gm,'<hr>');h=h.replace(/^&gt; (.+)$/gm,'<blockquote>$1</blockquote>');h=h.replace(/^[\-\*] (.+)$/gm,'<li>$1</li>');h=h.replace(/(<li>[\s\S]*?<\/li>(\s*<br>)?)+/g,m=>`<ul>${m.replace(/<br>/g,'')}</ul>`);h=h.replace(/^\d+\. (.+)$/gm,'<li>$1</li>');h=h.replace(/\n\n/g,'</p><p>');h=h.replace(/\n/g,'<br>');h='<p>'+h+'</p>';h=h.replace(/<p>\s*<\/p>/g,'');h=h.replace(/<p>\s*(<(?:h[34]|pre|ul|ol|hr|blockquote)>)/g,'$1');h=h.replace(/(<\/(?:h[34]|pre|ul|ol|hr|blockquote)>)\s*<\/p>/g,'$1');return h}

// ‚îÄ‚îÄ CHAT RENDERING ‚îÄ‚îÄ
function renderChat(){const area=document.getElementById('chatArea');const welcome=document.getElementById('welcomeScreen');const session=getCurrentSession();Array.from(area.children).forEach(ch=>{if(ch.id!=='welcomeScreen')ch.remove()});if(!session||session.messages.length===0){if(welcome)welcome.style.display='';return}if(welcome)welcome.style.display='none';session.messages.forEach(msg=>{if(msg.type!=='text'){const summary=msg.content||(msg.type==='quiz'?'üìù Practice ready ‚Üí see Practice Workspace':msg.type==='coding'?'üíª Coding problem ready ‚Üí see Practice Workspace':msg.type==='flashcards'?'üÉè Flashcards ready ‚Üí see Practice Workspace':msg.type==='score'?'üèÜ Score updated.':'Content generated.');const div=document.createElement('div');div.className='msg bot';div.innerHTML=`<div class="msg-avatar">üéì</div><div class="msg-bubble">${renderMarkdown(summary)}</div>`;area.appendChild(div);return}const div=document.createElement('div');div.className=`msg ${msg.role==='user'?'user':'bot'}`;div.innerHTML=`<div class="msg-avatar">${msg.role==='user'?'üë§':'üéì'}</div><div class="msg-bubble">${msg.role==='user'?escHtml(msg.content):renderMarkdown(msg.content)}</div>`;area.appendChild(div)});scrollToBottom()}
function getActiveStudyIndex(session){if(!session)return -1;const valid=i=>i>=0&&i<session.messages.length&&['quiz','coding','flashcards'].includes(session.messages[i].type);if(typeof session.activeStudyMsgIdx==='number'&&valid(session.activeStudyMsgIdx))return session.activeStudyMsgIdx;for(let i=session.messages.length-1;i>=0;i--)if(['quiz','coding','flashcards'].includes(session.messages[i].type)){session.activeStudyMsgIdx=i;return i}session.activeStudyMsgIdx=null;return -1}

function renderPracticePane(){const session=getCurrentSession();const body=document.getElementById('practiceBody');if(!body)return;body.innerHTML='';const idx=getActiveStudyIndex(session);if(!session||idx<0){body.innerHTML='<div class="practice-empty">No active practice yet. Use <strong>/quiz</strong>, <strong>/coding</strong>, or <strong>/flashcards</strong>.</div>';return}
const msg=session.messages[idx];const chip=document.createElement('div');chip.className='practice-chip';chip.textContent=msg.type==='quiz'?'Quiz':msg.type==='coding'?'Coding':'Flashcards';body.appendChild(chip);
if(msg.type==='quiz'){
  // progress bar
  const done=msg.data.questions.filter(q=>q.submitted).length;const total=msg.data.questions.length;const pbar=document.createElement('div');pbar.className='quiz-progress';pbar.id=`quizProgress_${idx}`;pbar.innerHTML=`<div class="quiz-progress-fill" style="width:${Math.round(done/total*100)}%"></div>`;body.appendChild(pbar);
  renderQuizCards(body,msg.data,idx);const scoreMsg=session.messages.slice(idx+1).find(m=>m.type==='score');if(scoreMsg?.data)renderScoreCard(body,scoreMsg.data)
}else if(msg.type==='coding'){renderProblemCards(body,msg.data,idx,false)}else if(msg.type==='flashcards'){renderFlashcards(body,msg.data,idx)}}

function clearPractice(){const session=getCurrentSession();if(!session)return;session.activeStudyMsgIdx=null;saveState();renderPracticePane()}
function addMsg(role,content,type,data){const session=getCurrentSession();if(!session)return;session.messages.push({role,content:content||'',type:type||'text',data:data||null});updateSessionTitle(session);saveState()}
function appendMsgEl(role,content){const area=document.getElementById('chatArea');const welcome=document.getElementById('welcomeScreen');if(welcome)welcome.style.display='none';const div=document.createElement('div');div.className=`msg ${role}`;div.innerHTML=`<div class="msg-avatar">${role==='user'?'üë§':'üéì'}</div><div class="msg-bubble">${role==='user'?escHtml(content):renderMarkdown(content)}</div>`;area.appendChild(div);scrollToBottom()}
function showTyping(){const area=document.getElementById('chatArea');const div=document.createElement('div');div.className='msg bot';div.id='typingIndicator';div.innerHTML=`<div class="msg-avatar">üéì</div><div class="msg-bubble"><div class="typing"><span></span><span></span><span></span></div></div>`;area.appendChild(div);scrollToBottom()}
function removeTyping(){const el=document.getElementById('typingIndicator');if(el)el.remove()}
function scrollToBottom(){const area=document.getElementById('chatArea');requestAnimationFrame(()=>{area.scrollTop=area.scrollHeight})}

// ‚îÄ‚îÄ QUIZ RENDERING ‚îÄ‚îÄ
function renderQuizCards(container,quizData,msgIdx){const{questions,type}=quizData;const isMulti=type==='multi';questions.forEach((q,qIdx)=>{const card=document.createElement('div');card.className='quiz-card';card.id=`quiz_${msgIdx}_${qIdx}`;const badge=isMulti?'<span class="badge badge-multi">Multi</span>':'<span class="badge badge-single">Single</span>';const instruction=isMulti?t('selectAll'):t('selectOne');let optionsHtml=q.options.map((opt,oIdx)=>{const cls=['quiz-option'];if(isMulti)cls.push('multi');const userAns=q.userAnswers||[];const checked=userAns.includes(oIdx);const submitted=!!q.submitted;const isCorrectOpt=isMulti?(q.correctIndices||[]).includes(oIdx):q.correctIndex===oIdx;if(submitted){cls.push('disabled');if(isCorrectOpt)cls.push('correct');else if(checked)cls.push('incorrect')}else if(checked)cls.push('selected');let marker='';if(submitted)marker=isCorrectOpt?'‚úì':(checked?'‚úó':'');else marker=checked?(isMulti?'‚úì':'‚óè'):'';return`<div class="${cls.join(' ')}" onclick="toggleOpt(${msgIdx},${qIdx},${oIdx},${isMulti})"><span class="marker">${marker}</span><span>${escHtml(opt)}</span></div>`}).join('');let explanationHtml='';if(q.submitted&&q.explanation){const rc=q.isCorrect?'correct-expl':(q.isPartial?'partial-expl':'incorrect-expl');const rt=q.isCorrect?t('correct'):(q.isPartial?t('partial'):t('incorrect'));explanationHtml=`<div class="quiz-explanation ${rc}"><strong>${rt}</strong> ${escHtml(q.explanation)}</div>`}let actionsHtml='';if(!q.submitted)actionsHtml=`<div class="quiz-actions"><button class="quiz-btn quiz-btn-primary" onclick="submitOpt(${msgIdx},${qIdx},${isMulti})">${t('submitAnswer')}</button></div>`;card.innerHTML=`<div class="quiz-card-header"><span style="font-size:.78rem;color:var(--text-secondary)">Q${qIdx+1}/${questions.length}</span>${badge}</div><div class="quiz-question">${escHtml(q.question)}</div><div style="font-size:.73rem;color:var(--text-secondary);margin-bottom:8px">${instruction}</div>${optionsHtml}${explanationHtml}${actionsHtml}`;container.appendChild(card)})}
function toggleOpt(msgIdx,qIdx,oIdx,isMulti){const session=getCurrentSession();if(!session)return;const q=session.messages[msgIdx]?.data?.questions?.[qIdx];if(!q||q.submitted)return;if(!q.userAnswers)q.userAnswers=[];if(isMulti){const i=q.userAnswers.indexOf(oIdx);if(i>=0)q.userAnswers.splice(i,1);else q.userAnswers.push(oIdx)}else{q.userAnswers=[oIdx]}saveState();rerenderQuizCard(msgIdx,qIdx)}
function submitOpt(msgIdx,qIdx,isMulti){const session=getCurrentSession();if(!session)return;const msg=session.messages[msgIdx];const q=msg?.data?.questions?.[qIdx];if(!q||!q.userAnswers||q.userAnswers.length===0){showToast(t('selectFirst'),'info');return}q.submitted=true;if(isMulti){const correct=(q.correctIndices||[]).slice().sort();const user=q.userAnswers.slice().sort();q.isCorrect=JSON.stringify(user)===JSON.stringify(correct);q.isPartial=!q.isCorrect&&user.some(u=>correct.includes(u))}else{q.isCorrect=q.userAnswers[0]===q.correctIndex;q.isPartial=false}state.stats.quizzes++;if(q.isCorrect)state.stats.correct++;else state.stats.wrong++;updateStatsUI();rerenderQuizCard(msgIdx,qIdx);updateQuizProgress(msgIdx);const allDone=msg.data.questions.every(qq=>qq.submitted);if(allDone){const cc=msg.data.questions.filter(qq=>qq.isCorrect).length;const tot=msg.data.questions.length;const scoreData={correct:cc,total:tot,percentage:Math.round(cc/tot*100)};addMsg('bot',`üèÜ Quiz: ${cc}/${tot}.`,'score',scoreData);appendMsgEl('bot',`üèÜ Quiz: ${cc}/${tot}.`);const body=document.getElementById('practiceBody');if(body)renderScoreCard(body,scoreData)}saveState();renderSessionList()}
function rerenderQuizCard(msgIdx,qIdx){const session=getCurrentSession();if(!session)return;const msg=session.messages[msgIdx];if(!msg||msg.type!=='quiz')return;const cardId=`quiz_${msgIdx}_${qIdx}`;const oldCard=document.getElementById(cardId);if(!oldCard)return;const q=msg.data.questions[qIdx];const isMulti=msg.data.type==='multi';const total=msg.data.questions.length;const badge=isMulti?'<span class="badge badge-multi">Multi</span>':'<span class="badge badge-single">Single</span>';const instruction=isMulti?t('selectAll'):t('selectOne');let optionsHtml=q.options.map((opt,oIdx)=>{const cls=['quiz-option'];if(isMulti)cls.push('multi');const userAns=q.userAnswers||[];const checked=userAns.includes(oIdx);const submitted=!!q.submitted;const isCorrectOpt=isMulti?(q.correctIndices||[]).includes(oIdx):q.correctIndex===oIdx;if(submitted){cls.push('disabled');if(isCorrectOpt)cls.push('correct');else if(checked)cls.push('incorrect')}else if(checked)cls.push('selected');let marker='';if(submitted)marker=isCorrectOpt?'‚úì':(checked?'‚úó':'');else marker=checked?(isMulti?'‚úì':'‚óè'):'';return`<div class="${cls.join(' ')}" onclick="toggleOpt(${msgIdx},${qIdx},${oIdx},${isMulti})"><span class="marker">${marker}</span><span>${escHtml(opt)}</span></div>`}).join('');let explanationHtml='';if(q.submitted&&q.explanation){const rc=q.isCorrect?'correct-expl':(q.isPartial?'partial-expl':'incorrect-expl');const rt=q.isCorrect?t('correct'):(q.isPartial?t('partial'):t('incorrect'));explanationHtml=`<div class="quiz-explanation ${rc}"><strong>${rt}</strong> ${escHtml(q.explanation)}</div>`}let actionsHtml='';if(!q.submitted)actionsHtml=`<div class="quiz-actions"><button class="quiz-btn quiz-btn-primary" onclick="submitOpt(${msgIdx},${qIdx},${isMulti})">${t('submitAnswer')}</button></div>`;oldCard.innerHTML=`<div class="quiz-card-header"><span style="font-size:.78rem;color:var(--text-secondary)">Q${qIdx+1}/${total}</span>${badge}</div><div class="quiz-question">${escHtml(q.question)}</div><div style="font-size:.73rem;color:var(--text-secondary);margin-bottom:8px">${instruction}</div>${optionsHtml}${explanationHtml}${actionsHtml}`}
function updateQuizProgress(msgIdx){const session=getCurrentSession();if(!session)return;const msg=session.messages[msgIdx];if(!msg||msg.type!=='quiz')return;const done=msg.data.questions.filter(q=>q.submitted).length;const total=msg.data.questions.length;const pbar=document.getElementById(`quizProgress_${msgIdx}`);if(pbar){const fill=pbar.querySelector('.quiz-progress-fill');if(fill)fill.style.width=`${Math.round(done/total*100)}%`}}

// ‚îÄ‚îÄ SCORE ‚îÄ‚îÄ
function renderScoreCard(container,data){const card=document.createElement('div');card.className='score-card';let emoji,comment;if(data.percentage>=100){emoji='üéâ';comment=t('excellent')}else if(data.percentage>=75){emoji='üåü';comment=t('great')}else if(data.percentage>=50){emoji='üëç';comment=t('good')}else{emoji='üìö';comment=t('keepStudying')}card.innerHTML=`<h3>${emoji} ${t('quizComplete')}</h3><div class="score-big">${data.correct}/${data.total}</div><div style="font-size:.88rem;opacity:.9">${comment}</div><div class="score-details"><div class="score-detail"><strong>${data.percentage}%</strong><span>${t('accuracy')}</span></div><div class="score-detail"><strong>${data.correct}</strong><span>${t('correctLabel')}</span></div><div class="score-detail"><strong>${data.total-data.correct}</strong><span>${t('wrongLabel')}</span></div></div>`;container.appendChild(card)}

// ‚îÄ‚îÄ CODING ‚îÄ‚îÄ
function renderProblemCards(container,data,msgIdx,countStats=true){(data.problems||[]).forEach((p,pIdx)=>{const card=document.createElement('div');card.className='problem-card';const hintId=`hint_${msgIdx}_${pIdx}`;const diffClass=(p.difficulty||'').toLowerCase()==='easy'?'diff-easy':(p.difficulty||'').toLowerCase()==='hard'?'diff-hard':'diff-medium';let constraintsHtml='';if(p.constraints&&p.constraints.length)constraintsHtml=`<div class="problem-section"><h5>Constraints</h5><ul>${p.constraints.map(c=>`<li>${escHtml(c)}</li>`).join('')}</ul></div>`;let examplesHtml='';if(p.examples&&p.examples.length)examplesHtml=`<div class="problem-section"><h5>Examples</h5>${p.examples.map(ex=>`<pre><code>Input:  ${escHtml(ex.input||'')}\nOutput: ${escHtml(ex.output||'')}${ex.explanation?'\nNote:   '+escHtml(ex.explanation):''}</code></pre>`).join('')}</div>`;let topicsHtml='';if(p.topics&&p.topics.length)topicsHtml=`<div class="problem-section"><h5>Topics</h5><div class="problem-topics">${p.topics.map(tp=>`<span class="problem-topic-tag">${escHtml(tp)}</span>`).join('')}</div></div>`;let hintHtml='';if(p.hint)hintHtml=`<button class="hint-toggle" onclick="toggleHint('${hintId}',this)">${t('hint')}</button><div class="problem-hint" id="${hintId}">üí° ${escHtml(p.hint)}</div>`;card.innerHTML=`<h4>üíª ${escHtml(p.title)} <span class="difficulty-tag ${diffClass}">${escHtml(p.difficulty||'Medium')}</span></h4><div class="problem-section"><h5>Description</h5><p>${escHtml(p.description)}</p></div>${constraintsHtml}${examplesHtml}${topicsHtml}${hintHtml}`;container.appendChild(card)});if(countStats){state.stats.problems+=(data.problems||[]).length;updateStatsUI()}}
function toggleHint(id,btn){const el=document.getElementById(id);if(!el)return;el.classList.toggle('visible');btn.textContent=el.classList.contains('visible')?t('hideHint'):t('hint')}

// ‚îÄ‚îÄ FLASHCARDS ‚îÄ‚îÄ
function renderFlashcards(container,data,msgIdx){(data.cards||[]).forEach((card,cIdx)=>{const el=document.createElement('div');el.className='quiz-card';const fcId=`fc_${msgIdx}_${cIdx}`;el.innerHTML=`<div class="quiz-card-header"><span style="font-size:.78rem;color:var(--text-secondary)">Card ${cIdx+1}/${data.cards.length}</span><span class="badge badge-coding">Flashcard</span></div><div class="quiz-question">${escHtml(card.term)}</div><div id="${fcId}" style="display:none;padding:10px 12px;background:var(--primary-light);border-radius:var(--radius-sm);margin-top:8px;font-size:.85rem;line-height:1.6">${escHtml(card.definition)}</div><div class="quiz-actions"><button class="quiz-btn quiz-btn-secondary" onclick="document.getElementById('${fcId}').style.display=document.getElementById('${fcId}').style.display==='none'?'block':'none'">üîÑ Flip</button></div>`;container.appendChild(el)})}

// ‚îÄ‚îÄ AI API ‚îÄ‚îÄ
async function callAI(messages,forceJson){const body={model:DEEPSEEK_MODEL,messages,temperature:0.7,max_tokens:4096};if(forceJson)body.response_format={type:'json_object'};const resp=await fetch(PROXY_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});if(!resp.ok){const errText=await resp.text().catch(()=>'');if(resp.status===502||resp.status===0)throw new Error(t('proxyError'));throw new Error(`API Error ${resp.status}: ${errText.slice(0,300)}`)}const data=await resp.json();return data?.choices?.[0]?.message?.content||''}

// ‚îÄ‚îÄ JSON PARSER ‚îÄ‚îÄ
function tryParseJSON(text){if(!text)return null;let c=text.replace(/```(?:json)?\s*/gi,'').trim();const iO=c.indexOf('{'),iA=c.indexOf('[');let start=-1;if(iO>=0&&iA>=0)start=Math.min(iO,iA);else if(iO>=0)start=iO;else if(iA>=0)start=iA;if(start<0)return null;c=c.slice(start);const open=c[0],close=open==='{'?'}':']';let depth=0,inStr=false,esc=false,end=-1;for(let i=0;i<c.length;i++){const ch=c[i];if(esc){esc=false;continue}if(ch==='\\'){esc=true;continue}if(ch==='"'){inStr=!inStr;continue}if(inStr)continue;if(ch===open)depth++;else if(ch===close){depth--;if(depth===0){end=i;break}}}if(end<0)return null;const j=c.slice(0,end+1);try{return JSON.parse(j)}catch(e){try{return JSON.parse(j.replace(/,\s*([}\]])/g,'$1'))}catch(e2){return null}}}

// ‚îÄ‚îÄ SYSTEM PROMPT ‚îÄ‚îÄ
function buildSystemPrompt(cmdType){const lang=state.language==='ru'?'Russian':state.language==='kk'?'Kazakh':'English';const mat=state.material?`\n\nSTUDY MATERIAL PROVIDED BY THE STUDENT ‚Äî base your questions/content on this:\n"""\n${state.material.slice(0,8000)}\n"""`:''
if(['quiz','multiquiz','coding','flashcards'].includes(cmdType)){const qc=state.questionCount||5;const schemas={
quiz:`You generate single-answer multiple choice quizzes. Output valid JSON only.\nSchema: {"type":"single","questions":[{"question":"text","options":["A","B","C","D"],"correctIndex":0,"explanation":"text"}]}\nRules:\n- "correctIndex" is 0-based\n- Always exactly 4 options\n- Generate exactly ${qc} questions\n- Challenging but fair\n- Helpful explanations`,
multiquiz:`You generate multi-answer quizzes. Output valid JSON only.\nSchema: {"type":"multi","questions":[{"question":"text","options":["A","B","C","D","E"],"correctIndices":[0,2],"explanation":"text"}]}\nRules:\n- "correctIndices" = array of 0-based indices\n- 4-5 options, usually 2-3 correct\n- Generate exactly ${qc} questions\n- Helpful explanations`,
coding:`You generate programming problems. Output valid JSON only.\nSchema: {"problems":[{"title":"text","difficulty":"Easy|Medium|Hard","description":"text","constraints":["text"],"examples":[{"input":"text","output":"text","explanation":"text"}],"topics":["text"],"hint":"text"}]}\nRules:\n- Clear LeetCode-style\n- 1-2 problems default\n- 2+ examples each\n- Helpful hints`,
flashcards:`You generate flashcards. Output valid JSON only.\nSchema: {"cards":[{"term":"text","definition":"text"}]}\nRules:\n- Generate ${Math.max(qc,8)} cards\n- Clear, concise definitions`};
return`You are "AI Exam Coach". Respond ONLY with valid JSON. No extra text. Language: ${lang}.\n\n${schemas[cmdType]}${mat}`}
return`You are "AI Exam Coach" ‚Äî expert educational AI. Always respond in ${lang}. Use markdown.\n\nCommands: /quiz, /multiquiz, /coding, /flashcards (JSON output), /explain, /summary (markdown).\nBe thorough but clear. Use examples.${mat}`}

// ‚îÄ‚îÄ FILE UPLOAD ‚îÄ‚îÄ
async function handleFileUpload(event){const file=event.target.files[0];if(!file)return;const ext=file.name.split('.').pop().toLowerCase();if(!['pdf','docx','xlsx','xls'].includes(ext)){showToast('Use .pdf, .docx, or .xlsx','error');event.target.value='';return}const btn=document.getElementById('fileUploadBtn');btn.classList.add('loading');updateFileInfo(file.name,t('uploading'));try{let text='';if(ext==='pdf')text=await parsePDF(file);else if(ext==='docx')text=await parseDOCX(file);else text=await parseXLSX(file);if(!text||text.trim().length<10)throw new Error('No text extracted.');const max=15000;if(text.length>max)text=text.slice(0,max)+'\n\n[‚Ä¶ truncated]';state.material=text;state.uploadedFileName=file.name;document.getElementById('materialInput').value=text;saveState();updateFileInfo(file.name,`‚úÖ ${text.length.toLocaleString()} chars`);showToast(t('uploadSuccess'),'success')}catch(err){console.error(err);updateFileInfo(file.name,`‚ùå ${err.message}`);showToast(t('uploadFail')+' '+err.message,'error')}finally{btn.classList.remove('loading');event.target.value=''}}
function clearUploadedFile(){state.material='';state.uploadedFileName='';document.getElementById('materialInput').value='';document.getElementById('fileInput').value='';document.getElementById('fileInfo').innerHTML='';saveState();showToast('Material cleared.','info')}
function updateFileInfo(name,status){const el=document.getElementById('fileInfo');if(el)el.innerHTML=`<span class="file-name">üìÑ ${escHtml(name)}</span> ‚Äî ${escHtml(status)}`}
async function parsePDF(file){if(typeof pdfjsLib==='undefined')throw new Error('PDF.js not loaded.');pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';const ab=await file.arrayBuffer();const pdf=await pdfjsLib.getDocument({data:ab}).promise;const pages=[];for(let i=1;i<=pdf.numPages;i++){const page=await pdf.getPage(i);const content=await page.getTextContent();pages.push(content.items.map(item=>item.str).join(' '))}return pages.join('\n\n')}
async function parseDOCX(file){if(typeof mammoth==='undefined')throw new Error('Mammoth not loaded.');const ab=await file.arrayBuffer();const result=await mammoth.extractRawText({arrayBuffer:ab});return result.value||''}
async function parseXLSX(file){if(typeof XLSX==='undefined')throw new Error('SheetJS not loaded.');const ab=await file.arrayBuffer();const wb=XLSX.read(ab,{type:'array'});const sheets=[];wb.SheetNames.forEach(name=>{const csv=XLSX.utils.sheet_to_csv(wb.Sheets[name],{blankrows:false});if(csv.trim())sheets.push(`=== ${name} ===\n${csv}`)});return sheets.join('\n\n')}

// ‚îÄ‚îÄ MESSAGE HANDLING ‚îÄ‚îÄ
async function sendMessage(){const input=document.getElementById('userInput');const text=input.value.trim();if(!text||state.isGenerating)return;if(!getCurrentSession())newSession();input.value='';autoResize(input);addMsg('user',text);appendMsgEl('user',text);const cmdType=detectCommand(text);const isStructured=['quiz','multiquiz','coding','flashcards'].includes(cmdType);state.isGenerating=true;document.getElementById('sendBtn').disabled=true;showTyping();try{await processAIRequest(text,cmdType,isStructured,0)}catch(err){removeTyping();const errMsg=`‚ö†Ô∏è ${err.message}`;addMsg('bot',errMsg);appendMsgEl('bot',errMsg);showToast(err.message,'error')}finally{state.isGenerating=false;document.getElementById('sendBtn').disabled=false;saveState();renderSessionList()}}

async function processAIRequest(userText,cmdType,isStructured,retryCount){const session=getCurrentSession();const history=session.messages.filter(m=>m.type==='text'&&m.content).slice(-16).map(m=>({role:m.role==='user'?'user':'assistant',content:m.content}));let apiMessages;if(isStructured){apiMessages=[{role:'system',content:buildSystemPrompt(cmdType)},{role:'user',content:userText}]}else{apiMessages=[{role:'system',content:buildSystemPrompt(cmdType)},...history];if(!history.length||history[history.length-1].content!==userText)apiMessages.push({role:'user',content:userText})}
const response=await callAI(apiMessages,isStructured);removeTyping();
if(isStructured){const parsed=tryParseJSON(response);
if((cmdType==='quiz'||cmdType==='multiquiz')&&parsed&&parsed.questions&&parsed.questions.length>0){if(!parsed.type)parsed.type=cmdType==='multiquiz'?'multi':'single';parsed.questions.forEach(q=>{q.userAnswers=[];q.submitted=false;q.isCorrect=false;q.isPartial=false});addMsg('bot',`üìù ${parsed.questions.length} questions ready.`,'quiz',parsed);session.activeStudyMsgIdx=session.messages.length-1;renderChat();renderPracticePane();showPracticeOnMobile();return}
if(cmdType==='coding'&&parsed&&parsed.problems&&parsed.problems.length>0){addMsg('bot',`üíª ${parsed.problems.length} problem(s) ready.`,'coding',parsed);session.activeStudyMsgIdx=session.messages.length-1;state.stats.problems+=parsed.problems.length;updateStatsUI();renderChat();renderPracticePane();showPracticeOnMobile();return}
if(cmdType==='flashcards'&&parsed&&parsed.cards&&parsed.cards.length>0){addMsg('bot',`üÉè ${parsed.cards.length} flashcards ready.`,'flashcards',parsed);session.activeStudyMsgIdx=session.messages.length-1;renderChat();renderPracticePane();showPracticeOnMobile();return}
if(retryCount<1){console.warn('JSON parse failed, retrying');showTyping();return processAIRequest(userText,cmdType,isStructured,retryCount+1)}console.error('JSON parse failed after retry')}
addMsg('bot',response);appendMsgEl('bot',response)}

function detectCommand(text){const l=text.toLowerCase().trim();if(l.startsWith('/multiquiz'))return'multiquiz';if(l.startsWith('/quiz'))return'quiz';if(l.startsWith('/coding')||l.startsWith('/code')||l.startsWith('/problem'))return'coding';if(l.startsWith('/flashcard'))return'flashcards';if(l.startsWith('/explain'))return'explain';if(l.startsWith('/summary')||l.startsWith('/summarize'))return'summary';return null}

function quickCommand(cmd){const input=document.getElementById('userInput');input.value=cmd+' ';input.focus();closeSidebar()}
function quickSend(text){document.getElementById('userInput').value=text;sendMessage()}

// ‚îÄ‚îÄ UI ‚îÄ‚îÄ
function handleInputKey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage()}}
function autoResize(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,180)+'px'}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('sidebarOverlay').classList.toggle('active')}
function closeSidebar(){document.getElementById('sidebar').classList.remove('open');document.getElementById('sidebarOverlay').classList.remove('active')}
function showToast(message,type){const toast=document.createElement('div');toast.className=`toast ${type||'info'}`;toast.textContent=message;document.body.appendChild(toast);setTimeout(()=>toast.remove(),4000)}
function updateStatsUI(){document.getElementById('statQuizzes').textContent=state.stats.quizzes;document.getElementById('statCorrect').textContent=state.stats.correct;document.getElementById('statWrong').textContent=state.stats.wrong;document.getElementById('statProblems').textContent=state.stats.problems}

// ‚îÄ‚îÄ DARK MODE ‚îÄ‚îÄ
function toggleDarkMode(){state.darkMode=!state.darkMode;applyDarkMode();saveState()}
function applyDarkMode(){document.documentElement.classList.toggle('dark',state.darkMode);document.getElementById('darkModeBtn').textContent=state.darkMode?'‚òÄÔ∏è':'üåô'}

// ‚îÄ‚îÄ PRACTICE PANEL TOGGLE ‚îÄ‚îÄ
function togglePractice(){state.practiceOpen=!state.practiceOpen;applyPracticeState();saveState()}
function applyPracticeState(){const panel=document.getElementById('practicePanel');const btn=document.getElementById('practiceToggleBtn');if(state.practiceOpen){panel.classList.remove('collapsed');btn.classList.add('active');btn.querySelector('#practiceToggleText').textContent='Practice ‚úì'}else{panel.classList.add('collapsed');btn.classList.remove('active');btn.querySelector('#practiceToggleText').textContent='Practice'}}

// ‚îÄ‚îÄ MOBILE TABS ‚îÄ‚îÄ
function switchMobileTab(tab){state.mobileTab=tab;const chatCol=document.getElementById('chatColumn');const practicePanel=document.getElementById('practicePanel');const tabChat=document.getElementById('tabChat');const tabPractice=document.getElementById('tabPractice');if(tab==='chat'){chatCol.style.display='';practicePanel.classList.add('collapsed');tabChat.classList.add('active');tabPractice.classList.remove('active')}else{chatCol.style.display='none';practicePanel.classList.remove('collapsed');tabChat.classList.remove('active');tabPractice.classList.add('active')}}
function showPracticeOnMobile(){if(window.innerWidth<=768){switchMobileTab('practice');if(!state.practiceOpen){state.practiceOpen=true;applyPracticeState()}}}

// ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ
function onLangChange(){state.language=document.getElementById('langSelect').value;document.getElementById('userInput').placeholder=t('placeholder');saveState()}
function onQCountChange(){state.questionCount=parseInt(document.getElementById('qcountSelect').value)||5;saveState()}
function saveMaterial(){state.material=document.getElementById('materialInput').value;saveState()}

// ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ
function exportSession(){const session=getCurrentSession();if(!session||session.messages.length===0){showToast('No session','info');return}let md=`# ${t('exportTitle')}\n## ${session.title.replace(/[<>&"]/g,'')}\n**Date:** ${new Date(session.created).toLocaleString()}\n\n---\n\n`;session.messages.forEach(msg=>{if(msg.role==='user')md+=`### üë§ You\n${msg.content}\n\n`;else if(msg.type==='quiz'&&msg.data){md+=`### üìù Quiz (${msg.data.type==='multi'?'Multi':'Single'})\n`;msg.data.questions.forEach((q,i)=>{md+=`**Q${i+1}.** ${q.question}\n`;q.options.forEach((o,j)=>{const ic=msg.data.type==='multi'?(q.correctIndices||[]).includes(j):j===q.correctIndex;md+=`${ic?'  ‚úÖ':'  ‚óªÔ∏è'} ${o}\n`});if(q.explanation)md+=`> ${q.explanation}\n`;if(q.submitted)md+=`> ${q.isCorrect?'‚úÖ Correct':'‚ùå Incorrect'}\n`;md+='\n'})}else if(msg.type==='coding'&&msg.data)(msg.data.problems||[]).forEach(p=>{md+=`### üíª ${p.title} [${p.difficulty}]\n${p.description}\n\n`});else if(msg.type==='flashcards'&&msg.data){md+=`### üÉè Flashcards\n`;(msg.data.cards||[]).forEach((c,i)=>{md+=`${i+1}. **${c.term}** ‚Äî ${c.definition}\n`});md+='\n'}else if(msg.type==='score'&&msg.data)md+=`### üèÜ ${msg.data.correct}/${msg.data.total} (${msg.data.percentage}%)\n\n`;else if(msg.role==='bot')md+=`### üéì AI\n${msg.content}\n\n`});const blob=new Blob([md],{type:'text/markdown'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`exam-coach-${session.id}.md`;a.click();URL.revokeObjectURL(url);showToast('Exported!','success')}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
function init(){loadState();document.getElementById('langSelect').value=state.language||'en';document.getElementById('materialInput').value=state.material||'';document.getElementById('userInput').placeholder=t('placeholder');document.getElementById('qcountSelect').value=state.questionCount||5;updateStatsUI();renderSessionList();applyDarkMode();applyPracticeState();if(state.uploadedFileName&&state.material)updateFileInfo(state.uploadedFileName,`‚úÖ ${state.material.length.toLocaleString()} chars`);if(state.currentSessionId&&getCurrentSession())renderChat();renderPracticePane();document.getElementById('userInput').focus();
// Handle resize: reset mobile tab state when going desktop
window.addEventListener('resize',()=>{if(window.innerWidth>768){document.getElementById('chatColumn').style.display='';applyPracticeState()}})}
document.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
