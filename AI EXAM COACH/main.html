<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Content-Security-Policy"
  content="default-src 'self';
    img-src 'self' data:;
    style-src 'self' 'unsafe-inline';
    script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com;
    connect-src 'self';
    worker-src 'self' blob:;
    base-uri 'self';
    form-action 'self';
    frame-ancestors 'none'">
<title>AI Exam Coach</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéì</text></svg>">

<!-- CDN: file parsing libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.8.0/mammoth.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root {
  --bg: #f0f2f5;
  --bg-card: #ffffff;
  --bg-sidebar: #1e1e2e;
  --bg-input: #f8f9fa;
  --text: #1a1a2e;
  --text-secondary: #6b7280;
  --text-sidebar: #cdd6f4;
  --primary: #6366f1;
  --primary-hover: #4f46e5;
  --primary-light: #eef2ff;
  --primary-glow: rgba(99,102,241,0.15);
  --success: #10b981;
  --success-light: #ecfdf5;
  --danger: #ef4444;
  --danger-light: #fef2f2;
  --warning: #f59e0b;
  --warning-light: #fffbeb;
  --border: #e5e7eb;
  --shadow: 0 1px 3px rgba(0,0,0,0.08);
  --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
  --radius: 12px;
  --radius-sm: 8px;
  --transition: 0.2s ease;
}
html{font-size:16px;scroll-behavior:smooth}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);line-height:1.6;overflow:hidden;height:100vh}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.app{display:flex;height:100vh;width:100vw}
.sidebar{width:300px;background:var(--bg-sidebar);color:var(--text-sidebar);display:flex;flex-direction:column;flex-shrink:0;transition:transform .3s ease;z-index:100}
.sidebar-header{padding:20px;border-bottom:1px solid rgba(255,255,255,0.08)}
.sidebar-header h1{font-size:1.25rem;font-weight:700;color:#fff;display:flex;align-items:center;gap:10px}
.sidebar-header h1 .logo{width:36px;height:36px;background:var(--primary);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.2rem}
.sidebar-body{flex:1;overflow-y:auto;padding:12px}
.sidebar-footer{padding:16px;border-top:1px solid rgba(255,255,255,0.08);font-size:0.75rem;color:rgba(255,255,255,0.4);text-align:center}
.sb-section{margin-bottom:16px}
.sb-section-title{font-size:0.7rem;text-transform:uppercase;letter-spacing:1.2px;color:rgba(255,255,255,0.35);padding:8px 12px;font-weight:600}
.sb-btn{width:100%;text-align:left;padding:10px 14px;border:none;background:transparent;color:var(--text-sidebar);border-radius:var(--radius-sm);cursor:pointer;font-size:0.875rem;display:flex;align-items:center;gap:10px;transition:background var(--transition)}
.sb-btn:hover{background:rgba(255,255,255,0.08)}
.sb-btn.active{background:rgba(99,102,241,0.25);color:#fff}
.sb-btn .sb-icon{width:20px;text-align:center;font-size:1rem}
.lang-group{padding:0 12px;margin-bottom:12px}
.lang-group label{display:block;font-size:0.75rem;color:rgba(255,255,255,0.5);margin-bottom:4px}
.lang-select{width:100%;padding:8px 10px;border-radius:var(--radius-sm);border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.06);color:#fff;font-size:0.8rem;outline:none;cursor:pointer}
.lang-select option{background:#1e1e2e;color:#fff}

.main{flex:1;display:flex;flex-direction:column;min-width:0}
.main-header{padding:14px 24px;background:var(--bg-card);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;flex-shrink:0}
.main-header .mode-title{font-weight:600;font-size:1rem}
.main-header .mode-desc{font-size:0.8rem;color:var(--text-secondary)}
.hamburger{display:none;background:none;border:none;font-size:1.4rem;cursor:pointer;padding:4px 8px;border-radius:6px;color:var(--text)}
.hamburger:hover{background:var(--bg-input)}

.workspace{display:grid;grid-template-columns:minmax(420px,1fr) 430px;flex:1;min-height:0}
.chat-column{display:flex;flex-direction:column;min-width:0;background:var(--bg)}
.chat-area{flex:1;overflow-y:auto;padding:24px;display:flex;flex-direction:column;gap:16px}
.chat-area::-webkit-scrollbar{width:6px}
.chat-area::-webkit-scrollbar-thumb{background:rgba(0,0,0,0.15);border-radius:3px}

.practice-panel{display:flex;flex-direction:column;background:var(--bg-card);border-left:1px solid var(--border);min-height:0}
.practice-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:8px}
.practice-title{font-size:0.9rem;font-weight:700}
.practice-subtitle{font-size:0.75rem;color:var(--text-secondary)}
.practice-body{padding:14px;overflow-y:auto;display:flex;flex-direction:column;gap:10px;flex:1;min-height:0}
.practice-empty{border:1px dashed var(--border);border-radius:var(--radius);padding:18px;color:var(--text-secondary);font-size:0.84rem;line-height:1.6;background:var(--bg-input)}
.practice-chip{font-size:0.68rem;text-transform:uppercase;letter-spacing:0.6px;padding:3px 8px;border-radius:20px;background:var(--primary-light);color:var(--primary);font-weight:600}

/* ‚îÄ‚îÄ MESSAGES ‚îÄ‚îÄ */
.msg{display:flex;gap:12px;max-width:85%;animation:msgIn 0.3s ease}
.msg.user{align-self:flex-end;flex-direction:row-reverse}
.msg.bot{align-self:flex-start}
.msg-avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0}
.msg.bot .msg-avatar{background:var(--primary-light);color:var(--primary)}
.msg.user .msg-avatar{background:#e0e7ff;color:var(--primary)}
.msg-bubble{padding:12px 16px;border-radius:var(--radius);font-size:0.9rem;line-height:1.65;word-wrap:break-word;overflow-wrap:break-word}
.msg.bot .msg-bubble{background:var(--bg-card);border:1px solid var(--border);border-top-left-radius:4px;box-shadow:var(--shadow)}
.msg.user .msg-bubble{background:var(--primary);color:#fff;border-top-right-radius:4px}
.msg-bubble p{margin-bottom:8px}
.msg-bubble p:last-child{margin-bottom:0}
.msg-bubble code{background:rgba(0,0,0,0.06);padding:2px 6px;border-radius:4px;font-family:'Cascadia Code','Fira Code',monospace;font-size:0.82rem}
.msg.user .msg-bubble code{background:rgba(255,255,255,0.2)}
.msg-bubble pre{background:#1e1e2e;color:#cdd6f4;padding:14px;border-radius:var(--radius-sm);overflow-x:auto;margin:8px 0;font-size:0.82rem;line-height:1.5}
.msg-bubble pre code{background:transparent;padding:0;color:inherit}
.msg-bubble ul,.msg-bubble ol{padding-left:20px;margin:8px 0}
.msg-bubble li{margin-bottom:4px}
.msg-bubble strong{font-weight:600}
.msg-bubble h3,.msg-bubble h4{margin:12px 0 6px;font-weight:600}
.msg-bubble h3{font-size:1rem}
.msg-bubble h4{font-size:0.9rem}
.msg-bubble blockquote{border-left:3px solid var(--primary);padding-left:12px;margin:8px 0;color:var(--text-secondary);font-style:italic}
.msg-bubble hr{border:none;border-top:1px solid var(--border);margin:12px 0}
.msg.user .msg-bubble pre{background:rgba(0,0,0,0.3)}
@keyframes msgIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

.typing{display:flex;gap:4px;padding:4px 0}
.typing span{width:8px;height:8px;background:var(--text-secondary);border-radius:50%;animation:bounce 1.4s infinite both;opacity:0.4}
.typing span:nth-child(2){animation-delay:0.2s}
.typing span:nth-child(3){animation-delay:0.4s}
@keyframes bounce{0%,80%,100%{transform:scale(0.6)}40%{transform:scale(1);opacity:1}}

/* ‚îÄ‚îÄ QUIZ ‚îÄ‚îÄ */
.quiz-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin:4px 0;box-shadow:var(--shadow);max-width:600px;animation:msgIn 0.3s ease}
.quiz-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.quiz-card-header .badge{font-size:0.7rem;padding:3px 10px;border-radius:20px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
.badge-single{background:var(--primary-light);color:var(--primary)}
.badge-multi{background:var(--warning-light);color:#b45309}
.badge-coding{background:#f0fdf4;color:#15803d}
.quiz-question{font-weight:600;font-size:0.95rem;margin-bottom:16px;line-height:1.5}
.quiz-option{display:flex;align-items:flex-start;gap:10px;padding:10px 14px;border:2px solid var(--border);border-radius:var(--radius-sm);margin-bottom:8px;cursor:pointer;transition:all var(--transition);font-size:0.875rem;user-select:none}
.quiz-option:hover:not(.disabled){border-color:var(--primary);background:var(--primary-light)}
.quiz-option.selected{border-color:var(--primary);background:var(--primary-light)}
.quiz-option.correct{border-color:var(--success);background:var(--success-light)}
.quiz-option.incorrect{border-color:var(--danger);background:var(--danger-light)}
.quiz-option.disabled{cursor:default;opacity:0.7}
.quiz-option.disabled.correct{opacity:1}
.quiz-option .marker{width:22px;height:22px;border:2px solid var(--border);border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:0.7rem;transition:all var(--transition)}
.quiz-option.multi .marker{border-radius:4px}
.quiz-option.selected .marker{border-color:var(--primary);background:var(--primary);color:#fff}
.quiz-option.correct .marker{border-color:var(--success);background:var(--success);color:#fff}
.quiz-option.incorrect .marker{border-color:var(--danger);background:var(--danger);color:#fff}
.quiz-explanation{margin-top:14px;padding:12px 14px;border-radius:var(--radius-sm);font-size:0.84rem;line-height:1.6}
.quiz-explanation.correct-expl{background:var(--success-light);border-left:3px solid var(--success)}
.quiz-explanation.incorrect-expl{background:var(--danger-light);border-left:3px solid var(--danger)}
.quiz-explanation.partial-expl{background:var(--warning-light);border-left:3px solid var(--warning)}
.quiz-btn{padding:8px 20px;border:none;border-radius:var(--radius-sm);font-size:0.85rem;font-weight:600;cursor:pointer;transition:all var(--transition)}
.quiz-btn-primary{background:var(--primary);color:#fff}
.quiz-btn-primary:hover{background:var(--primary-hover)}
.quiz-btn-secondary{background:var(--bg-input);color:var(--text);border:1px solid var(--border)}
.quiz-btn-secondary:hover{background:var(--border)}
.quiz-actions{display:flex;gap:8px;margin-top:14px;flex-wrap:wrap}

/* ‚îÄ‚îÄ SCORE ‚îÄ‚îÄ */
.score-card{background:linear-gradient(135deg,var(--primary),#8b5cf6);color:#fff;border-radius:var(--radius);padding:24px;text-align:center;max-width:500px;margin:4px 0;box-shadow:var(--shadow-lg);animation:msgIn 0.3s ease}
.score-card h3{font-size:1.3rem;margin-bottom:4px}
.score-card .score-big{font-size:3rem;font-weight:800;margin:12px 0}
.score-card .score-details{display:flex;justify-content:center;gap:24px;margin-top:12px;font-size:0.85rem;opacity:0.9}
.score-card .score-detail{display:flex;flex-direction:column;align-items:center;gap:2px}
.score-card .score-detail strong{font-size:1.2rem}

/* ‚îÄ‚îÄ CODING ‚îÄ‚îÄ */
.problem-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin:4px 0;box-shadow:var(--shadow);max-width:650px;animation:msgIn 0.3s ease}
.problem-card h4{display:flex;align-items:center;gap:8px;margin-bottom:12px;font-size:1rem;flex-wrap:wrap}
.problem-card .difficulty-tag{font-size:0.7rem;padding:2px 8px;border-radius:10px;font-weight:600}
.diff-easy{background:#ecfdf5;color:#059669}
.diff-medium{background:#fffbeb;color:#b45309}
.diff-hard{background:#fef2f2;color:#dc2626}
.problem-section{margin-bottom:14px}
.problem-section h5{font-size:0.82rem;font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px}
.problem-section p,.problem-section ul,.problem-section ol{font-size:0.88rem}
.problem-section ul,.problem-section ol{padding-left:18px}
.problem-hint{background:var(--warning-light);border:1px solid #fde68a;border-radius:var(--radius-sm);padding:10px 14px;font-size:0.84rem;display:none;margin-top:8px}
.problem-hint.visible{display:block}
.hint-toggle{font-size:0.8rem;color:var(--primary);cursor:pointer;background:none;border:none;font-weight:600;padding:0}
.hint-toggle:hover{text-decoration:underline}
.problem-topics{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px}
.problem-topic-tag{background:var(--primary-light);color:var(--primary);padding:2px 8px;border-radius:10px;font-size:0.75rem}

/* ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ */
.input-area{padding:16px 24px;background:var(--bg-card);border-top:1px solid var(--border);flex-shrink:0;z-index:8;box-shadow:0 -6px 20px rgba(0,0,0,0.04)}
.input-row{display:flex;gap:10px;align-items:flex-end;max-width:900px;margin:0 auto}
.input-box{flex:1;position:relative}
.input-box textarea{width:100%;padding:12px 16px;border:2px solid var(--border);border-radius:var(--radius);font-size:0.9rem;font-family:inherit;resize:none;outline:none;transition:border var(--transition);min-height:48px;max-height:200px;line-height:1.5;background:var(--bg-input)}
.input-box textarea:focus{border-color:var(--primary)}
.input-box textarea::placeholder{color:var(--text-secondary)}
.send-btn{width:48px;height:48px;border-radius:var(--radius);border:none;background:var(--primary);color:#fff;font-size:1.2rem;cursor:pointer;transition:all var(--transition);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.send-btn:hover{background:var(--primary-hover);transform:scale(1.05)}
.send-btn:disabled{background:var(--border);color:var(--text-secondary);cursor:not-allowed;transform:none}
.input-hint{font-size:0.72rem;color:var(--text-secondary);margin-top:6px;text-align:center}

/* ‚îÄ‚îÄ WELCOME ‚îÄ‚îÄ */
.quick-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:12px}
.quick-action-btn{padding:8px 16px;border-radius:20px;border:1px solid var(--border);background:var(--bg-card);font-size:0.8rem;cursor:pointer;transition:all var(--transition);color:var(--text);display:flex;align-items:center;gap:6px}
.quick-action-btn:hover{border-color:var(--primary);background:var(--primary-light);color:var(--primary)}
.welcome{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;text-align:center;padding:40px 20px}
.welcome-icon{font-size:4rem;margin-bottom:16px}
.welcome h2{font-size:1.6rem;font-weight:700;margin-bottom:8px}
.welcome p{color:var(--text-secondary);max-width:500px;margin-bottom:24px;font-size:0.95rem}
.feature-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;max-width:700px;width:100%;margin-bottom:24px}
.feature-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;text-align:left;transition:all var(--transition);cursor:pointer}
.feature-card:hover{border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-glow)}
.feature-card .fc-icon{font-size:1.5rem;margin-bottom:8px}
.feature-card h4{font-size:0.85rem;font-weight:600;margin-bottom:4px}
.feature-card p{font-size:0.78rem;color:var(--text-secondary)}

/* ‚îÄ‚îÄ SIDEBAR WIDGETS ‚îÄ‚îÄ */
.stats-bar{display:flex;gap:16px;padding:0 12px;margin-bottom:8px;flex-wrap:wrap}
.stat-item{font-size:0.75rem;color:rgba(255,255,255,0.6);display:flex;align-items:center;gap:4px}
.stat-item strong{color:rgba(255,255,255,0.9)}
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:99}
.sidebar-overlay.active{display:block}
.session-item{padding:8px 12px;border-radius:var(--radius-sm);cursor:pointer;font-size:0.8rem;color:rgba(255,255,255,0.6);transition:background var(--transition);display:flex;align-items:center;gap:8px;margin-bottom:2px}
.session-item:hover{background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.9)}
.session-item.active{background:rgba(99,102,241,0.2);color:#fff}
.session-item .session-icon{font-size:0.9rem}
.session-item .session-text{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
.session-item .session-delete{opacity:0;font-size:0.8rem;background:none;border:none;color:rgba(255,255,255,0.4);cursor:pointer;padding:2px 4px;border-radius:4px}
.session-item:hover .session-delete{opacity:1}
.session-item .session-delete:hover{color:#ef4444;background:rgba(239,68,68,0.15)}
.material-area{padding:0 12px;margin-bottom:12px}
.material-textarea{width:100%;height:100px;padding:8px 10px;border-radius:var(--radius-sm);border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.06);color:#fff;font-size:0.78rem;outline:none;resize:vertical;font-family:inherit;transition:border var(--transition)}
.material-textarea:focus{border-color:var(--primary)}
.material-textarea::placeholder{color:rgba(255,255,255,0.25)}
.new-session-btn{width:calc(100% - 24px);margin:0 12px 8px;padding:10px;border-radius:var(--radius-sm);border:1px dashed rgba(255,255,255,0.15);background:transparent;color:rgba(255,255,255,0.6);cursor:pointer;font-size:0.82rem;display:flex;align-items:center;justify-content:center;gap:6px;transition:all var(--transition)}
.new-session-btn:hover{border-color:var(--primary);color:var(--primary);background:rgba(99,102,241,0.08)}
.export-btn{width:calc(100% - 24px);margin:0 12px 8px;padding:8px;border-radius:var(--radius-sm);border:1px solid rgba(255,255,255,0.1);background:transparent;color:rgba(255,255,255,0.5);cursor:pointer;font-size:0.78rem;display:flex;align-items:center;justify-content:center;gap:6px;transition:all var(--transition)}
.export-btn:hover{border-color:rgba(255,255,255,0.3);color:rgba(255,255,255,0.8)}

/* ‚îÄ‚îÄ FILE UPLOAD ‚îÄ‚îÄ */
.file-upload-row{display:flex;gap:6px;padding:0 12px;margin-bottom:8px;align-items:center}
.file-upload-btn{flex:1;padding:9px 10px;border-radius:var(--radius-sm);border:1px dashed rgba(255,255,255,0.2);background:rgba(99,102,241,0.06);color:rgba(255,255,255,0.7);cursor:pointer;font-size:0.78rem;text-align:center;transition:all var(--transition);display:flex;align-items:center;justify-content:center;gap:6px}
.file-upload-btn:hover{border-color:var(--primary);color:var(--primary);background:rgba(99,102,241,0.12)}
.file-upload-btn.loading{pointer-events:none;opacity:0.6}
.file-clear-btn{padding:9px 12px;border-radius:var(--radius-sm);border:1px solid rgba(255,255,255,0.1);background:transparent;color:rgba(255,255,255,0.4);cursor:pointer;font-size:0.78rem;transition:all var(--transition)}
.file-clear-btn:hover{border-color:var(--danger);color:var(--danger);background:rgba(239,68,68,0.08)}
.file-info{padding:0 12px;margin-bottom:6px;font-size:0.72rem;color:rgba(255,255,255,0.5);line-height:1.4}
.file-info .file-name{color:var(--primary);font-weight:600}
.file-info .file-chars{color:rgba(255,255,255,0.4)}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast{position:fixed;top:20px;right:20px;padding:12px 20px;border-radius:var(--radius-sm);color:#fff;font-size:0.85rem;z-index:1000;animation:toastIn 0.3s ease;box-shadow:var(--shadow-lg);max-width:400px}
.toast.success{background:var(--success)}
.toast.error{background:var(--danger)}
.toast.info{background:var(--primary)}
@keyframes toastIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}

/* ‚îÄ‚îÄ ERROR ‚îÄ‚îÄ */
.error-retry-card{background:var(--danger-light);border:1px solid var(--danger);border-radius:var(--radius);padding:16px;max-width:500px;margin:4px 0;animation:msgIn 0.3s ease}
.error-retry-card p{font-size:0.85rem;margin-bottom:10px;color:var(--danger)}

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media(max-width:768px){
  .sidebar{position:fixed;left:0;top:0;bottom:0;transform:translateX(-100%)}
  .sidebar.open{transform:translateX(0)}
  .hamburger{display:block}
  .workspace{grid-template-columns:1fr;grid-template-rows:1fr 45vh}
  .practice-panel{border-left:none;border-top:1px solid var(--border)}
  .msg{max-width:95%}
  .feature-grid{grid-template-columns:1fr}
  .quiz-card,.problem-card,.score-card{max-width:100%}
}
.sidebar-body::-webkit-scrollbar{width:4px}
.sidebar-body::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:2px}
</style>
</head>
<body>

<div class="app">
  <!-- ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h1><span class="logo">üéì</span>AI Exam Coach</h1>
    </div>
    <div class="sidebar-body">
      <button class="new-session-btn" onclick="newSession()">Ôºã New Session</button>

      <!-- Language -->
      <div class="sb-section">
        <div class="sb-section-title">Language</div>
        <div class="lang-group">
          <select class="lang-select" id="langSelect" onchange="onLangChange()">
            <option value="en">English</option>
            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
            <option value="kk">“ö–∞–∑–∞“õ—à–∞</option>
          </select>
        </div>
      </div>

      <!-- Study Material -->
      <div class="sb-section">
        <div class="sb-section-title">üìö Study Material</div>
        <div class="file-upload-row">
          <label class="file-upload-btn" id="fileUploadBtn">
            üìé Upload .pdf / .docx / .xlsx
            <input type="file" id="fileInput" accept=".pdf,.docx,.xlsx,.xls" style="display:none" onchange="handleFileUpload(event)">
          </label>
          <button class="file-clear-btn" onclick="clearUploadedFile()" title="Clear file">‚úï</button>
        </div>
        <div class="file-info" id="fileInfo"></div>
        <div class="material-area">
          <textarea class="material-textarea" id="materialInput" placeholder="Paste notes here, or upload a file above. The AI generates questions from this material." oninput="saveMaterial()"></textarea>
        </div>
      </div>

      <!-- Quick Tools -->
      <div class="sb-section">
        <div class="sb-section-title">Quick Tools</div>
        <button class="sb-btn" onclick="quickCommand('/quiz')">
          <span class="sb-icon">üìù</span> Single-Answer Quiz
        </button>
        <button class="sb-btn" onclick="quickCommand('/multiquiz')">
          <span class="sb-icon">‚òëÔ∏è</span> Multi-Answer Quiz
        </button>
        <button class="sb-btn" onclick="quickCommand('/coding')">
          <span class="sb-icon">üíª</span> Coding Problem
        </button>
        <button class="sb-btn" onclick="quickCommand('/explain')">
          <span class="sb-icon">üí°</span> Explain Topic
        </button>
        <button class="sb-btn" onclick="quickCommand('/flashcards')">
          <span class="sb-icon">üÉè</span> Flashcards
        </button>
        <button class="sb-btn" onclick="quickCommand('/summary')">
          <span class="sb-icon">üìã</span> Summarize Material
        </button>
      </div>

      <!-- Session Stats -->
      <div class="sb-section">
        <div class="sb-section-title">üìä Session Stats</div>
        <div class="stats-bar">
          <div class="stat-item">üìù <strong id="statQuizzes">0</strong> quizzes</div>
          <div class="stat-item">‚úÖ <strong id="statCorrect">0</strong> correct</div>
          <div class="stat-item">‚ùå <strong id="statWrong">0</strong> wrong</div>
          <div class="stat-item">üíª <strong id="statProblems">0</strong> problems</div>
        </div>
      </div>

      <!-- History -->
      <div class="sb-section">
        <div class="sb-section-title">History</div>
        <div id="sessionList"></div>
      </div>

      <button class="export-btn" onclick="exportSession()">üì• Export Session as Markdown</button>
    </div>
    <div class="sidebar-footer">
      AI Exam Coach &bull; Powered by DeepSeek AI<br>
      Deployed on Netlify
    </div>
  </aside>

  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

  <!-- ‚ïê‚ïê‚ïê MAIN AREA ‚ïê‚ïê‚ïê -->
  <div class="main">
    <div class="main-header">
      <button class="hamburger" onclick="toggleSidebar()">‚ò∞</button>
      <div>
        <div class="mode-title">AI Exam Coach</div>
        <div class="mode-desc">Your personal exam preparation assistant</div>
      </div>
    </div>

    <div class="workspace">
      <!-- LEFT: Chat -->
      <div class="chat-column">
        <div class="chat-area" id="chatArea">
          <div class="welcome" id="welcomeScreen">
            <div class="welcome-icon">üéì</div>
            <h2>Welcome to AI Exam Coach</h2>
            <p>I help you prepare for exams with AI-generated quizzes, coding problems, explanations, and flashcards. Upload your study material in the sidebar or just tell me a topic!</p>
            <div class="feature-grid">
              <div class="feature-card" onclick="quickCommand('/quiz')">
                <div class="fc-icon">üìù</div>
                <h4>Single-Answer Quiz</h4>
                <p>Classic multiple choice ‚Äî one correct answer</p>
              </div>
              <div class="feature-card" onclick="quickCommand('/multiquiz')">
                <div class="fc-icon">‚òëÔ∏è</div>
                <h4>Multi-Answer Quiz</h4>
                <p>Select all correct answers from the options</p>
              </div>
              <div class="feature-card" onclick="quickCommand('/coding')">
                <div class="fc-icon">üíª</div>
                <h4>Coding Problems</h4>
                <p>Practice programming exercises on any topic</p>
              </div>
              <div class="feature-card" onclick="quickCommand('/explain')">
                <div class="fc-icon">üí°</div>
                <h4>Explain Topics</h4>
                <p>Get clear explanations of complex concepts</p>
              </div>
              <div class="feature-card" onclick="quickCommand('/flashcards')">
                <div class="fc-icon">üÉè</div>
                <h4>Flashcards</h4>
                <p>Quick term &amp; definition review cards</p>
              </div>
              <div class="feature-card" onclick="quickCommand('/summary')">
                <div class="fc-icon">üìã</div>
                <h4>Summarize</h4>
                <p>Get a concise summary of your material</p>
              </div>
            </div>
            <div class="quick-actions">
              <button class="quick-action-btn" onclick="quickSend('/quiz Generate 5 questions about data structures')">üöÄ Try a sample quiz</button>
              <button class="quick-action-btn" onclick="quickSend('/coding Create a linked list problem')">üíª Try a coding problem</button>
            </div>
          </div>
        </div>

        <div class="input-area">
          <div class="input-row">
            <div class="input-box">
              <textarea id="userInput" rows="1" placeholder="Ask anything, or type /quiz, /coding, /explain‚Ä¶" onkeydown="handleInputKey(event)" oninput="autoResize(this)"></textarea>
            </div>
            <button class="send-btn" id="sendBtn" onclick="sendMessage()" title="Send">‚ñ∂</button>
          </div>
          <div class="input-hint">Enter to send &bull; Shift+Enter for new line &bull; /quiz &bull; /multiquiz &bull; /coding &bull; /explain &bull; /flashcards &bull; /summary</div>
        </div>
      </div>

      <!-- RIGHT: Practice workspace -->
      <aside class="practice-panel" id="practicePanel">
        <div class="practice-header">
          <div>
            <div class="practice-title">Practice Workspace</div>
            <div class="practice-subtitle">Your latest quiz / coding / flashcards</div>
          </div>
          <button class="quiz-btn quiz-btn-secondary" onclick="clearPractice()">Clear</button>
        </div>
        <div class="practice-body" id="practiceBody">
          <div class="practice-empty">No active practice yet. Use <strong>/quiz</strong>, <strong>/multiquiz</strong>, <strong>/coding</strong>, or <strong>/flashcards</strong>.</div>
        </div>
      </aside>
    </div>
  </div>
</div>

<script>
// ================================================================
//  CONFIG ‚Äî Netlify-only. API key lives in Netlify env vars.
//  For local dev, run: npx netlify dev (reads .env automatically)
// ================================================================
const PROXY_ENDPOINT = '/.netlify/functions/deepseek-proxy';
const DEEPSEEK_MODEL = 'deepseek-chat';

// ============================================================
// STATE
// ============================================================
const state = {
  sessions: [],
  currentSessionId: null,
  language: 'en',
  material: '',
  uploadedFileName: '',
  isGenerating: false,
  stats: { quizzes: 0, correct: 0, wrong: 0, problems: 0 }
};

// ============================================================
// i18n
// ============================================================
const i18n = {
  en: {
    placeholder: 'Ask anything, or type /quiz, /coding, /explain‚Ä¶',
    correct: '‚úÖ Correct!',
    incorrect: '‚ùå Incorrect.',
    partial: '‚ö†Ô∏è Partially correct.',
    selectAll: 'Select all that apply, then click Submit.',
    selectOne: 'Select one answer, then click Submit.',
    submitAnswer: 'Submit Answer',
    quizComplete: 'Quiz Complete!',
    hint: 'üí° Show Hint',
    hideHint: 'üí° Hide Hint',
    exportTitle: 'AI Exam Coach ‚Äî Session Export',
    selectFirst: 'Please select an answer first.',
    excellent: 'Excellent work!',
    great: 'Great job! Almost perfect!',
    good: 'Good effort! Review the mistakes.',
    keepStudying: 'Keep studying, you\'ll get there!',
    accuracy: 'Accuracy',
    correctLabel: 'Correct',
    wrongLabel: 'Wrong',
    parseError: 'The AI response couldn\'t be parsed as a quiz. Retrying...',
    uploadSuccess: 'File loaded successfully!',
    uploadFail: 'Failed to parse this file.',
    uploading: 'Parsing file‚Ä¶',
    proxyError: '‚ö†Ô∏è Could not reach the AI server. Make sure the site is deployed on Netlify or running via "npx netlify dev".',
  },
  ru: {
    placeholder: '–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å: /quiz, /coding, /explain‚Ä¶',
    correct: '‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!',
    incorrect: '‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ.',
    partial: '‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ.',
    selectAll: '–í—ã–±–µ—Ä–∏—Ç–µ –≤—Å–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏ –Ω–∞–∂–º–∏—Ç–µ –û—Ç–≤–µ—Ç–∏—Ç—å.',
    selectOne: '–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –æ—Ç–≤–µ—Ç –∏ –Ω–∞–∂–º–∏—Ç–µ –û—Ç–≤–µ—Ç–∏—Ç—å.',
    submitAnswer: '–û—Ç–≤–µ—Ç–∏—Ç—å',
    quizComplete: '–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!',
    hint: 'üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞',
    hideHint: 'üí° –°–∫—Ä—ã—Ç—å',
    exportTitle: 'AI Exam Coach ‚Äî –≠–∫—Å–ø–æ—Ä—Ç —Å–µ—Å—Å–∏–∏',
    selectFirst: '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç.',
    excellent: '–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!',
    great: '–ó–¥–æ—Ä–æ–≤–æ! –ü–æ—á—Ç–∏ –∏–¥–µ–∞–ª—å–Ω–æ!',
    good: '–•–æ—Ä–æ—à–æ! –†–∞–∑–±–µ—Ä–∏—Ç–µ –æ—à–∏–±–∫–∏.',
    keepStudying: '–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —É—á–∏—Ç—å—Å—è, –≤—Å—ë –ø–æ–ª—É—á–∏—Ç—Å—è!',
    accuracy: '–¢–æ—á–Ω–æ—Å—Ç—å',
    correctLabel: '–í–µ—Ä–Ω–æ',
    wrongLabel: '–û—à–∏–±–∫–∏',
    parseError: '–û—Ç–≤–µ—Ç –ò–ò –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å. –ü—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞...',
    uploadSuccess: '–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω!',
    uploadFail: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª.',
    uploading: '–ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞‚Ä¶',
    proxyError: '‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É –ò–ò. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–∞–π—Ç —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç –Ω–∞ Netlify –∏–ª–∏ –∑–∞–ø—É—â–µ–Ω —á–µ—Ä–µ–∑ "npx netlify dev".',
  },
  kk: {
    placeholder: '–°“±—Ä–∞“õ “õ–æ–π—ã“£—ã–∑: /quiz, /coding, /explain‚Ä¶',
    correct: '‚úÖ –î“±—Ä—ã—Å!',
    incorrect: '‚ùå “ö–∞—Ç–µ.',
    partial: '‚ö†Ô∏è –ñ–∞—Ä—Ç—ã–ª–∞–π –¥“±—Ä—ã—Å.',
    selectAll: '–ë–∞—Ä–ª—ã“õ –¥“±—Ä—ã—Å –Ω“±—Å“õ–∞–ª–∞—Ä–¥—ã —Ç–∞“£–¥–∞–ø, –ñ—ñ–±–µ—Ä—É —Ç“Ø–π–º–µ—Å—ñ–Ω –±–∞—Å—ã“£—ã–∑.',
    selectOne: '–ë—ñ—Ä –∂–∞—É–∞–ø—Ç—ã —Ç–∞“£–¥–∞–ø, –ñ—ñ–±–µ—Ä—É —Ç“Ø–π–º–µ—Å—ñ–Ω –±–∞—Å—ã“£—ã–∑.',
    submitAnswer: '–ñ–∞—É–∞–ø—Ç—ã –∂—ñ–±–µ—Ä—É',
    quizComplete: '–¢–µ—Å—Ç –∞—è“õ—Ç–∞–ª–¥—ã!',
    hint: 'üí° –ö–µ“£–µ—Å –∫”©—Ä—Å–µ—Ç—É',
    hideHint: 'üí° –ñ–∞—Å—ã—Ä—É',
    exportTitle: 'AI Exam Coach ‚Äî –°–µ–∞–Ω—Å —ç–∫—Å–ø–æ—Ä—Ç—ã',
    selectFirst: '–ê–ª–¥—ã–º–µ–Ω –∂–∞—É–∞–ø—Ç—ã —Ç–∞“£–¥–∞“£—ã–∑.',
    excellent: '–ö–µ—Ä–µ–º–µ—Ç –∂“±–º—ã—Å!',
    great: '”®—Ç–µ –∂–∞“õ—Å—ã! –ú—ñ–Ω—Å—ñ–∑–≥–µ –∂–∞“õ—ã–Ω!',
    good: '–ñ–∞“õ—Å—ã –Ω”ô—Ç–∏–∂–µ! “ö–∞—Ç–µ–ª–µ—Ä–¥—ñ “õ–∞–π—Ç–∞–ª–∞“£—ã–∑.',
    keepStudying: '–û“õ—É–¥—ã –∂–∞–ª“ì–∞—Å—Ç—ã—Ä—ã“£—ã–∑, –±”ô—Ä—ñ –±–æ–ª–∞–¥—ã!',
    accuracy: '–î”ô–ª–¥—ñ–∫',
    correctLabel: '–î“±—Ä—ã—Å',
    wrongLabel: '“ö–∞—Ç–µ',
    parseError: '–ò–ò –∂–∞—É–∞–±—ã–Ω —Ç–∞–ª–¥–∞—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã. “ö–∞–π—Ç–∞ ”ô—Ä–µ–∫–µ—Ç—Ç–µ–Ω–µ–º—ñ–∑...',
    uploadSuccess: '–§–∞–π–ª —Å”ô—Ç—Ç—ñ –∂“Ø–∫—Ç–µ–ª–¥—ñ!',
    uploadFail: '–§–∞–π–ª–¥—ã –æ“õ—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.',
    uploading: '–§–∞–π–ª –æ“õ—ã–ª—É–¥–∞‚Ä¶',
    proxyError: '‚ö†Ô∏è –ò–ò —Å–µ—Ä–≤–µ—Ä—ñ–Ω–µ “õ–æ—Å—ã–ª—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã. –°–∞–π—Ç Netlify-–¥–µ –æ—Ä–Ω–∞–ª–∞—Å—Ç—ã—Ä—ã–ª“ì–∞–Ω—ã–Ω–∞ –Ω–µ–º–µ—Å–µ "npx netlify dev" –∞—Ä“õ—ã–ª—ã —ñ—Å–∫–µ “õ–æ—Å—ã–ª“ì–∞–Ω—ã–Ω–∞ –∫”©–∑ –∂–µ—Ç–∫—ñ–∑—ñ“£—ñ–∑.',
  }
};

function t(key) { return (i18n[state.language] && i18n[state.language][key]) || i18n.en[key] || key; }

// ============================================================
// PERSISTENCE
// ============================================================
function saveState() {
  try {
    localStorage.setItem('examCoachState', JSON.stringify({
      sessions: state.sessions,
      currentSessionId: state.currentSessionId,
      language: state.language,
      material: state.material,
      uploadedFileName: state.uploadedFileName,
      stats: state.stats
    }));
  } catch (e) { console.warn('Save failed', e); }
}

function loadState() {
  try {
    const s = JSON.parse(localStorage.getItem('examCoachState') || '{}');
    if (s.language) state.language = s.language;
    if (s.material) state.material = s.material;
    if (s.uploadedFileName) state.uploadedFileName = s.uploadedFileName;
    if (s.sessions) state.sessions = s.sessions;
    if (s.currentSessionId) state.currentSessionId = s.currentSessionId;
    if (s.stats) state.stats = s.stats;
  } catch (e) { console.warn('Load failed', e); }
}

// ============================================================
// SESSIONS
// ============================================================
function getCurrentSession() {
  return state.sessions.find(s => s.id === state.currentSessionId);
}

function newSession() {
  const session = {
    id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
    title: 'New Session',
    messages: [],
    activeStudyMsgIdx: null,
    created: Date.now()
  };
  state.sessions.unshift(session);
  state.currentSessionId = session.id;
  saveState();
  renderSessionList();
  renderChat();
  renderPracticePane();
  closeSidebar();
}

function switchSession(id) {
  state.currentSessionId = id;
  saveState();
  renderSessionList();
  renderChat();
  renderPracticePane();
  closeSidebar();
}

function deleteSession(id, evt) {
  evt.stopPropagation();
  state.sessions = state.sessions.filter(s => s.id !== id);
  if (state.currentSessionId === id) {
    state.currentSessionId = state.sessions.length ? state.sessions[0].id : null;
  }
  saveState();
  renderSessionList();
  renderChat();
  renderPracticePane();
}

function renderSessionList() {
  const el = document.getElementById('sessionList');
  if (!el) return;
  el.innerHTML = state.sessions.map(s => `
    <div class="session-item ${s.id === state.currentSessionId ? 'active' : ''}" onclick="switchSession('${s.id}')">
      <span class="session-icon">üí¨</span>
      <span class="session-text">${escHtml(s.title)}</span>
      <button class="session-delete" onclick="deleteSession('${s.id}', event)" title="Delete">‚úï</button>
    </div>
  `).join('');
}

function updateSessionTitle(session) {
  const first = session.messages.find(m => m.role === 'user');
  if (first) {
    session.title = first.content.slice(0, 60) + (first.content.length > 60 ? '‚Ä¶' : '');
  }
}

// ============================================================
// HTML HELPERS
// ============================================================
function escHtml(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = String(s);
  return d.innerHTML;
}

function renderMarkdown(text) {
  if (!text) return '';
  let h = escHtml(text);
  h = h.replace(/```(\w*)\n([\s\S]*?)```/g, (_, lang, code) => `<pre><code>${code.trim()}</code></pre>`);
  h = h.replace(/`([^`]+)`/g, '<code>$1</code>');
  h = h.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  h = h.replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g, '<em>$1</em>');
  h = h.replace(/^#### (.+)$/gm, '<h4>$1</h4>');
  h = h.replace(/^### (.+)$/gm, '<h3>$1</h3>');
  h = h.replace(/^## (.+)$/gm, '<h3>$1</h3>');
  h = h.replace(/^---$/gm, '<hr>');
  h = h.replace(/^&gt; (.+)$/gm, '<blockquote>$1</blockquote>');
  h = h.replace(/^[\-\*] (.+)$/gm, '<li>$1</li>');
  h = h.replace(/(<li>[\s\S]*?<\/li>(\s*<br>)?)+/g, match => `<ul>${match.replace(/<br>/g, '')}</ul>`);
  h = h.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
  h = h.replace(/\n\n/g, '</p><p>');
  h = h.replace(/\n/g, '<br>');
  h = '<p>' + h + '</p>';
  h = h.replace(/<p>\s*<\/p>/g, '');
  h = h.replace(/<p>\s*(<(?:h[34]|pre|ul|ol|hr|blockquote)>)/g, '$1');
  h = h.replace(/(<\/(?:h[34]|pre|ul|ol|hr|blockquote)>)\s*<\/p>/g, '$1');
  return h;
}

// ============================================================
// CHAT RENDERING
// ============================================================
function renderChat() {
  const area = document.getElementById('chatArea');
  const welcome = document.getElementById('welcomeScreen');
  const session = getCurrentSession();

  Array.from(area.children).forEach(ch => { if (ch.id !== 'welcomeScreen') ch.remove(); });

  if (!session || session.messages.length === 0) {
    if (welcome) welcome.style.display = '';
    return;
  }
  if (welcome) welcome.style.display = 'none';

  session.messages.forEach((msg) => {
    if (msg.type !== 'text') {
      const summary = msg.content
        || (msg.type === 'quiz' ? 'üìù Practice generated ‚Äî see Practice Workspace ‚Üí'
        : msg.type === 'coding' ? 'üíª Coding problem generated ‚Äî see Practice Workspace ‚Üí'
        : msg.type === 'flashcards' ? 'üÉè Flashcards generated ‚Äî see Practice Workspace ‚Üí'
        : msg.type === 'score' ? 'üèÜ Score updated in Practice Workspace.'
        : 'Structured content generated.');
      const div = document.createElement('div');
      div.className = 'msg bot';
      div.innerHTML = `<div class="msg-avatar">üéì</div><div class="msg-bubble">${renderMarkdown(summary)}</div>`;
      area.appendChild(div);
      return;
    }
    const div = document.createElement('div');
    div.className = `msg ${msg.role === 'user' ? 'user' : 'bot'}`;
    div.innerHTML = `
      <div class="msg-avatar">${msg.role === 'user' ? 'üë§' : 'üéì'}</div>
      <div class="msg-bubble">${msg.role === 'user' ? escHtml(msg.content) : renderMarkdown(msg.content)}</div>
    `;
    area.appendChild(div);
  });
  scrollToBottom();
}

function getActiveStudyIndex(session) {
  if (!session) return -1;
  const valid = (i) => i >= 0 && i < session.messages.length && ['quiz', 'coding', 'flashcards'].includes(session.messages[i].type);
  if (typeof session.activeStudyMsgIdx === 'number' && valid(session.activeStudyMsgIdx)) return session.activeStudyMsgIdx;
  for (let i = session.messages.length - 1; i >= 0; i--) {
    if (['quiz', 'coding', 'flashcards'].includes(session.messages[i].type)) {
      session.activeStudyMsgIdx = i;
      return i;
    }
  }
  session.activeStudyMsgIdx = null;
  return -1;
}

function renderPracticePane() {
  const session = getCurrentSession();
  const body = document.getElementById('practiceBody');
  if (!body) return;
  body.innerHTML = '';

  const idx = getActiveStudyIndex(session);
  if (!session || idx < 0) {
    body.innerHTML = '<div class="practice-empty">No active practice yet. Use <strong>/quiz</strong>, <strong>/multiquiz</strong>, <strong>/coding</strong>, or <strong>/flashcards</strong>.</div>';
    return;
  }

  const msg = session.messages[idx];
  const chip = document.createElement('div');
  chip.className = 'practice-chip';
  chip.textContent = msg.type === 'quiz' ? 'Quiz Workspace' : msg.type === 'coding' ? 'Coding Workspace' : 'Flashcards Workspace';
  body.appendChild(chip);

  if (msg.type === 'quiz') {
    renderQuizCards(body, msg.data, idx);
    const scoreMsg = session.messages.slice(idx + 1).find(m => m.type === 'score');
    if (scoreMsg?.data) renderScoreCard(body, scoreMsg.data);
  } else if (msg.type === 'coding') {
    renderProblemCards(body, msg.data, idx, false);
  } else if (msg.type === 'flashcards') {
    renderFlashcards(body, msg.data, idx);
  }
}

function clearPractice() {
  const session = getCurrentSession();
  if (!session) return;
  session.activeStudyMsgIdx = null;
  saveState();
  renderPracticePane();
}

function addMsg(role, content, type, data) {
  const session = getCurrentSession();
  if (!session) return;
  session.messages.push({ role, content: content || '', type: type || 'text', data: data || null });
  updateSessionTitle(session);
  saveState();
}

function appendMsgEl(role, content) {
  const area = document.getElementById('chatArea');
  const welcome = document.getElementById('welcomeScreen');
  if (welcome) welcome.style.display = 'none';
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  div.innerHTML = `
    <div class="msg-avatar">${role === 'user' ? 'üë§' : 'üéì'}</div>
    <div class="msg-bubble">${role === 'user' ? escHtml(content) : renderMarkdown(content)}</div>
  `;
  area.appendChild(div);
  scrollToBottom();
}

function showTyping() {
  const area = document.getElementById('chatArea');
  const div = document.createElement('div');
  div.className = 'msg bot'; div.id = 'typingIndicator';
  div.innerHTML = `<div class="msg-avatar">üéì</div><div class="msg-bubble"><div class="typing"><span></span><span></span><span></span></div></div>`;
  area.appendChild(div);
  scrollToBottom();
}

function removeTyping() {
  const el = document.getElementById('typingIndicator');
  if (el) el.remove();
}

function scrollToBottom() {
  const area = document.getElementById('chatArea');
  requestAnimationFrame(() => { area.scrollTop = area.scrollHeight; });
}

// ============================================================
// QUIZ RENDERING
// ============================================================
function renderQuizCards(container, quizData, msgIdx) {
  const { questions, type } = quizData;
  const isMulti = type === 'multi';

  questions.forEach((q, qIdx) => {
    const cardId = `quiz_${msgIdx}_${qIdx}`;
    const card = document.createElement('div');
    card.className = 'quiz-card'; card.id = cardId;

    const badge = isMulti
      ? '<span class="badge badge-multi">Multi-Answer</span>'
      : '<span class="badge badge-single">Single Answer</span>';
    const instruction = isMulti ? t('selectAll') : t('selectOne');

    let optionsHtml = q.options.map((opt, oIdx) => {
      const cls = ['quiz-option'];
      if (isMulti) cls.push('multi');
      const userAns = q.userAnswers || [];
      const checked = userAns.includes(oIdx);
      const submitted = !!q.submitted;
      const isCorrectOpt = isMulti ? (q.correctIndices || []).includes(oIdx) : q.correctIndex === oIdx;

      if (submitted) {
        cls.push('disabled');
        if (isCorrectOpt) cls.push('correct');
        else if (checked) cls.push('incorrect');
      } else if (checked) {
        cls.push('selected');
      }

      let marker = '';
      if (submitted) marker = isCorrectOpt ? '‚úì' : (checked ? '‚úó' : '');
      else marker = checked ? (isMulti ? '‚úì' : '‚óè') : '';

      return `<div class="${cls.join(' ')}" onclick="toggleOpt(${msgIdx},${qIdx},${oIdx},${isMulti})" data-idx="${oIdx}">
        <span class="marker">${marker}</span><span>${escHtml(opt)}</span>
      </div>`;
    }).join('');

    let explanationHtml = '';
    if (q.submitted && q.explanation) {
      const rc = q.isCorrect ? 'correct-expl' : (q.isPartial ? 'partial-expl' : 'incorrect-expl');
      const rt = q.isCorrect ? t('correct') : (q.isPartial ? t('partial') : t('incorrect'));
      explanationHtml = `<div class="quiz-explanation ${rc}"><strong>${rt}</strong> ${escHtml(q.explanation)}</div>`;
    }

    let actionsHtml = '';
    if (!q.submitted) {
      actionsHtml = `<div class="quiz-actions"><button class="quiz-btn quiz-btn-primary" onclick="submitOpt(${msgIdx},${qIdx},${isMulti})">${t('submitAnswer')}</button></div>`;
    }

    card.innerHTML = `
      <div class="quiz-card-header">
        <span style="font-size:0.8rem;color:var(--text-secondary)">Q${qIdx + 1} / ${questions.length}</span>
        ${badge}
      </div>
      <div class="quiz-question">${escHtml(q.question)}</div>
      <div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:8px">${instruction}</div>
      ${optionsHtml}
      ${explanationHtml}
      ${actionsHtml}
    `;
    container.appendChild(card);
  });
}

function toggleOpt(msgIdx, qIdx, oIdx, isMulti) {
  const session = getCurrentSession();
  if (!session) return;
  const q = session.messages[msgIdx]?.data?.questions?.[qIdx];
  if (!q || q.submitted) return;
  if (!q.userAnswers) q.userAnswers = [];

  if (isMulti) {
    const i = q.userAnswers.indexOf(oIdx);
    if (i >= 0) q.userAnswers.splice(i, 1); else q.userAnswers.push(oIdx);
  } else {
    q.userAnswers = [oIdx];
  }
  saveState();
  renderPracticePane();
}

function submitOpt(msgIdx, qIdx, isMulti) {
  const session = getCurrentSession();
  if (!session) return;
  const msg = session.messages[msgIdx];
  const q = msg?.data?.questions?.[qIdx];
  if (!q || !q.userAnswers || q.userAnswers.length === 0) {
    showToast(t('selectFirst'), 'info'); return;
  }

  q.submitted = true;
  if (isMulti) {
    const correct = (q.correctIndices || []).slice().sort();
    const user = q.userAnswers.slice().sort();
    q.isCorrect = JSON.stringify(user) === JSON.stringify(correct);
    q.isPartial = !q.isCorrect && user.some(u => correct.includes(u));
  } else {
    q.isCorrect = q.userAnswers[0] === q.correctIndex;
    q.isPartial = false;
  }

  state.stats.quizzes++;
  if (q.isCorrect) state.stats.correct++; else state.stats.wrong++;
  updateStatsUI();

  const allDone = msg.data.questions.every(qq => qq.submitted);
  if (allDone) {
    const correctCount = msg.data.questions.filter(qq => qq.isCorrect).length;
    const total = msg.data.questions.length;
    addMsg('bot', `üèÜ Quiz completed: ${correctCount}/${total}.`, 'score', { correct: correctCount, total, percentage: Math.round((correctCount / total) * 100) });
  }
  saveState();
  renderChat();
  renderPracticePane();
}

// ============================================================
// SCORE CARD
// ============================================================
function renderScoreCard(container, data) {
  const card = document.createElement('div');
  card.className = 'score-card';
  let emoji, comment;
  if (data.percentage >= 100) { emoji = 'üéâ'; comment = t('excellent'); }
  else if (data.percentage >= 75) { emoji = 'üåü'; comment = t('great'); }
  else if (data.percentage >= 50) { emoji = 'üëç'; comment = t('good'); }
  else { emoji = 'üìö'; comment = t('keepStudying'); }
  card.innerHTML = `
    <h3>${emoji} ${t('quizComplete')}</h3>
    <div class="score-big">${data.correct} / ${data.total}</div>
    <div style="font-size:0.9rem;opacity:0.9">${comment}</div>
    <div class="score-details">
      <div class="score-detail"><strong>${data.percentage}%</strong><span>${t('accuracy')}</span></div>
      <div class="score-detail"><strong>${data.correct}</strong><span>${t('correctLabel')}</span></div>
      <div class="score-detail"><strong>${data.total - data.correct}</strong><span>${t('wrongLabel')}</span></div>
    </div>
  `;
  container.appendChild(card);
}

// ============================================================
// CODING PROBLEM CARDS
// ============================================================
function renderProblemCards(container, data, msgIdx, countStats = true) {
  (data.problems || []).forEach((p, pIdx) => {
    const card = document.createElement('div');
    card.className = 'problem-card';
    const hintId = `hint_${msgIdx}_${pIdx}`;
    const diffClass = (p.difficulty || '').toLowerCase() === 'easy' ? 'diff-easy' : (p.difficulty || '').toLowerCase() === 'hard' ? 'diff-hard' : 'diff-medium';

    let constraintsHtml = '';
    if (p.constraints && p.constraints.length) {
      constraintsHtml = `<div class="problem-section"><h5>Constraints</h5><ul>${p.constraints.map(c => `<li>${escHtml(c)}</li>`).join('')}</ul></div>`;
    }
    let examplesHtml = '';
    if (p.examples && p.examples.length) {
      examplesHtml = `<div class="problem-section"><h5>Examples</h5>${p.examples.map(ex =>
        `<pre><code>Input:  ${escHtml(ex.input || '')}\nOutput: ${escHtml(ex.output || '')}${ex.explanation ? '\nNote:   ' + escHtml(ex.explanation) : ''}</code></pre>`
      ).join('')}</div>`;
    }
    let topicsHtml = '';
    if (p.topics && p.topics.length) {
      topicsHtml = `<div class="problem-section"><h5>Topics</h5><div class="problem-topics">${p.topics.map(tp => `<span class="problem-topic-tag">${escHtml(tp)}</span>`).join('')}</div></div>`;
    }
    let hintHtml = '';
    if (p.hint) {
      hintHtml = `<button class="hint-toggle" onclick="toggleHint('${hintId}',this)">${t('hint')}</button><div class="problem-hint" id="${hintId}">üí° ${escHtml(p.hint)}</div>`;
    }
    card.innerHTML = `
      <h4>üíª ${escHtml(p.title)} <span class="difficulty-tag ${diffClass}">${escHtml(p.difficulty || 'Medium')}</span></h4>
      <div class="problem-section"><h5>Description</h5><p>${escHtml(p.description)}</p></div>
      ${constraintsHtml}${examplesHtml}${topicsHtml}${hintHtml}
    `;
    container.appendChild(card);
  });
  if (countStats) {
    state.stats.problems += (data.problems || []).length;
    updateStatsUI();
  }
}

function toggleHint(id, btn) {
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.toggle('visible');
  btn.textContent = el.classList.contains('visible') ? t('hideHint') : t('hint');
}

// ============================================================
// FLASHCARDS
// ============================================================
function renderFlashcards(container, data, msgIdx) {
  (data.cards || []).forEach((card, cIdx) => {
    const el = document.createElement('div');
    el.className = 'quiz-card';
    const fcId = `fc_${msgIdx}_${cIdx}`;
    el.innerHTML = `
      <div class="quiz-card-header">
        <span style="font-size:0.8rem;color:var(--text-secondary)">Card ${cIdx + 1} / ${data.cards.length}</span>
        <span class="badge badge-coding">Flashcard</span>
      </div>
      <div class="quiz-question">${escHtml(card.term)}</div>
      <div id="${fcId}" style="display:none;padding:12px 14px;background:var(--primary-light);border-radius:var(--radius-sm);margin-top:8px;font-size:0.88rem;line-height:1.6">${escHtml(card.definition)}</div>
      <div class="quiz-actions">
        <button class="quiz-btn quiz-btn-secondary" onclick="document.getElementById('${fcId}').style.display=document.getElementById('${fcId}').style.display==='none'?'block':'none'">üîÑ Flip Card</button>
      </div>
    `;
    container.appendChild(el);
  });
}

// ============================================================
// AI API CALL ‚Äî always via Netlify proxy
// ============================================================
async function callAI(messages, forceJson) {
  const body = {
    model: DEEPSEEK_MODEL,
    messages,
    temperature: 0.7,
    max_tokens: 4096
  };

  if (forceJson) {
    body.response_format = { type: 'json_object' };
  }

  const resp = await fetch(PROXY_ENDPOINT, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });

  if (!resp.ok) {
    const errText = await resp.text().catch(() => '');
    if (resp.status === 502 || resp.status === 0) {
      throw new Error(t('proxyError'));
    }
    throw new Error(`API Error ${resp.status}: ${errText.slice(0, 300)}`);
  }

  const data = await resp.json();
  return data?.choices?.[0]?.message?.content || '';
}

// ============================================================
// ROBUST JSON PARSER
// ============================================================
function tryParseJSON(text) {
  if (!text) return null;
  let cleaned = text.replace(/```(?:json)?\s*/gi, '').trim();

  const iObj = cleaned.indexOf('{');
  const iArr = cleaned.indexOf('[');
  let start = -1;
  if (iObj >= 0 && iArr >= 0) start = Math.min(iObj, iArr);
  else if (iObj >= 0) start = iObj;
  else if (iArr >= 0) start = iArr;
  if (start < 0) return null;

  cleaned = cleaned.slice(start);

  const openChar = cleaned[0];
  const closeChar = openChar === '{' ? '}' : ']';
  let depth = 0, inString = false, escape = false, end = -1;

  for (let i = 0; i < cleaned.length; i++) {
    const ch = cleaned[i];
    if (escape) { escape = false; continue; }
    if (ch === '\\') { escape = true; continue; }
    if (ch === '"') { inString = !inString; continue; }
    if (inString) continue;
    if (ch === openChar) depth++;
    else if (ch === closeChar) { depth--; if (depth === 0) { end = i; break; } }
  }
  if (end < 0) return null;

  const jsonStr = cleaned.slice(0, end + 1);
  try { return JSON.parse(jsonStr); } catch (e) {
    try { return JSON.parse(jsonStr.replace(/,\s*([}\]])/g, '$1')); } catch (e2) { return null; }
  }
}

// ============================================================
// SYSTEM PROMPT
// ============================================================
function buildSystemPrompt(cmdType) {
  const lang = state.language === 'ru' ? 'Russian' : state.language === 'kk' ? 'Kazakh' : 'English';
  const mat = state.material
    ? `\n\nSTUDY MATERIAL PROVIDED BY THE STUDENT ‚Äî base your questions/content on this:\n"""\n${state.material.slice(0, 8000)}\n"""`
    : '';

  if (['quiz', 'multiquiz', 'coding', 'flashcards'].includes(cmdType)) {
    const schemas = {
      quiz: `You generate single-answer multiple choice quizzes. Output valid JSON only.
Schema: {"type":"single","questions":[{"question":"text","options":["A","B","C","D"],"correctIndex":0,"explanation":"text"}]}
Rules:
- "correctIndex" is 0-based index of the ONE correct option
- Always exactly 4 options per question
- 5 questions by default unless user specifies otherwise
- Challenging but fair questions with plausible distractors
- Helpful explanations referencing the material`,

      multiquiz: `You generate multi-answer multiple choice quizzes. Output valid JSON only.
Schema: {"type":"multi","questions":[{"question":"text","options":["A","B","C","D","E"],"correctIndices":[0,2],"explanation":"text"}]}
Rules:
- "correctIndices" is array of 0-based indices for ALL correct options
- 4-5 options per question, usually 2-3 correct answers
- 5 questions by default unless user specifies otherwise
- Challenging but fair with plausible distractors
- Helpful explanations`,

      coding: `You generate programming practice problems. Output valid JSON only.
Schema: {"problems":[{"title":"text","difficulty":"Easy|Medium|Hard","description":"text","constraints":["text"],"examples":[{"input":"text","output":"text","explanation":"text"}],"topics":["text"],"hint":"text"}]}
Rules:
- Clear LeetCode-style problem descriptions
- 1-2 problems by default unless user specifies otherwise
- Include at least 2 examples per problem
- Include helpful hints`,

      flashcards: `You generate study flashcards. Output valid JSON only.
Schema: {"cards":[{"term":"text","definition":"text"}]}
Rules:
- 8-10 cards by default unless user specifies otherwise
- Clear, concise definitions`
    };

    return `You are "AI Exam Coach". Respond ONLY with valid JSON. No extra text, no markdown, no code fences. Just the raw JSON object.
Language for all text content: ${lang}.

${schemas[cmdType]}
${mat}`;
  }

  return `You are "AI Exam Coach" ‚Äî an expert educational AI assistant helping students prepare for exams.
Always respond in ${lang}. Use markdown formatting for readability.

Available commands (the user may use these):
- /quiz ‚Äî Single-answer quiz (you output JSON)
- /multiquiz ‚Äî Multi-answer quiz (you output JSON)
- /coding ‚Äî Programming problems (you output JSON)
- /flashcards ‚Äî Term/definition cards (you output JSON)
- /explain ‚Äî Detailed concept explanations (markdown text)
- /summary ‚Äî Summarize material (markdown text)

For /explain, /summary, and free chat: respond with helpful, well-structured markdown text.
Be thorough but clear. Use examples where helpful.
${mat}`;
}

// ============================================================
// FILE UPLOAD & PARSING
// ============================================================
async function handleFileUpload(event) {
  const file = event.target.files[0];
  if (!file) return;

  const ext = file.name.split('.').pop().toLowerCase();
  if (!['pdf', 'docx', 'xlsx', 'xls'].includes(ext)) {
    showToast('Unsupported file type. Use .pdf, .docx, or .xlsx', 'error');
    event.target.value = '';
    return;
  }

  const btn = document.getElementById('fileUploadBtn');
  btn.classList.add('loading');
  btn.querySelector('input').disabled = true;
  updateFileInfo(file.name, t('uploading'));

  try {
    let text = '';
    if (ext === 'pdf') {
      text = await parsePDF(file);
    } else if (ext === 'docx') {
      text = await parseDOCX(file);
    } else if (ext === 'xlsx' || ext === 'xls') {
      text = await parseXLSX(file);
    }

    if (!text || text.trim().length < 10) {
      throw new Error('No readable text extracted from file.');
    }

    // Truncate very large files (AI context is limited)
    const maxChars = 15000;
    if (text.length > maxChars) {
      text = text.slice(0, maxChars) + '\n\n[‚Ä¶ truncated ‚Äî file too large, first ~15,000 characters used]';
    }

    state.material = text;
    state.uploadedFileName = file.name;
    document.getElementById('materialInput').value = text;
    saveState();
    updateFileInfo(file.name, `‚úÖ ${text.length.toLocaleString()} chars extracted`);
    showToast(t('uploadSuccess'), 'success');

  } catch (err) {
    console.error('File parse error:', err);
    updateFileInfo(file.name, `‚ùå ${err.message}`);
    showToast(t('uploadFail') + ' ' + err.message, 'error');
  } finally {
    btn.classList.remove('loading');
    btn.querySelector('input').disabled = false;
    event.target.value = '';
  }
}

function clearUploadedFile() {
  state.material = '';
  state.uploadedFileName = '';
  document.getElementById('materialInput').value = '';
  document.getElementById('fileInput').value = '';
  document.getElementById('fileInfo').innerHTML = '';
  saveState();
  showToast('Material cleared.', 'info');
}

function updateFileInfo(name, status) {
  const el = document.getElementById('fileInfo');
  if (!el) return;
  el.innerHTML = `<span class="file-name">üìÑ ${escHtml(name)}</span> ‚Äî <span class="file-chars">${escHtml(status)}</span>`;
}

// ‚îÄ‚îÄ PDF ‚îÄ‚îÄ
async function parsePDF(file) {
  if (typeof pdfjsLib === 'undefined') throw new Error('PDF.js library not loaded.');
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
  const pages = [];

  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    const strings = content.items.map(item => item.str);
    pages.push(strings.join(' '));
  }
  return pages.join('\n\n');
}

// ‚îÄ‚îÄ DOCX ‚îÄ‚îÄ
async function parseDOCX(file) {
  if (typeof mammoth === 'undefined') throw new Error('Mammoth library not loaded.');
  const arrayBuffer = await file.arrayBuffer();
  const result = await mammoth.extractRawText({ arrayBuffer });
  return result.value || '';
}

// ‚îÄ‚îÄ XLSX ‚îÄ‚îÄ
async function parseXLSX(file) {
  if (typeof XLSX === 'undefined') throw new Error('SheetJS library not loaded.');
  const arrayBuffer = await file.arrayBuffer();
  const workbook = XLSX.read(arrayBuffer, { type: 'array' });
  const sheets = [];

  workbook.SheetNames.forEach(name => {
    const sheet = workbook.Sheets[name];
    const csv = XLSX.utils.sheet_to_csv(sheet, { blankrows: false });
    if (csv.trim()) {
      sheets.push(`=== Sheet: ${name} ===\n${csv}`);
    }
  });
  return sheets.join('\n\n');
}

// ============================================================
// MESSAGE HANDLING
// ============================================================
async function sendMessage() {
  const input = document.getElementById('userInput');
  const text = input.value.trim();
  if (!text || state.isGenerating) return;

  if (!getCurrentSession()) newSession();

  input.value = '';
  autoResize(input);

  addMsg('user', text);
  appendMsgEl('user', text);

  const cmdType = detectCommand(text);
  const isStructured = ['quiz', 'multiquiz', 'coding', 'flashcards'].includes(cmdType);

  state.isGenerating = true;
  document.getElementById('sendBtn').disabled = true;
  showTyping();

  try {
    await processAIRequest(text, cmdType, isStructured, 0);
  } catch (err) {
    removeTyping();
    const errMsg = `‚ö†Ô∏è ${err.message}`;
    addMsg('bot', errMsg);
    appendMsgEl('bot', errMsg);
    showToast(err.message, 'error');
  } finally {
    state.isGenerating = false;
    document.getElementById('sendBtn').disabled = false;
    saveState();
    renderSessionList();
  }
}

async function processAIRequest(userText, cmdType, isStructured, retryCount) {
  const session = getCurrentSession();
  const history = session.messages
    .filter(m => m.type === 'text' && m.content)
    .slice(-16)
    .map(m => ({ role: m.role === 'user' ? 'user' : 'assistant', content: m.content }));

  let apiMessages;
  if (isStructured) {
    apiMessages = [
      { role: 'system', content: buildSystemPrompt(cmdType) },
      { role: 'user', content: userText }
    ];
  } else {
    apiMessages = [
      { role: 'system', content: buildSystemPrompt(cmdType) },
      ...history
    ];
    if (!history.length || history[history.length - 1].content !== userText) {
      apiMessages.push({ role: 'user', content: userText });
    }
  }

  const response = await callAI(apiMessages, isStructured);
  removeTyping();

  if (isStructured) {
    const parsed = tryParseJSON(response);

    // Quiz
    if ((cmdType === 'quiz' || cmdType === 'multiquiz') && parsed && parsed.questions && parsed.questions.length > 0) {
      if (!parsed.type) parsed.type = cmdType === 'multiquiz' ? 'multi' : 'single';
      parsed.questions.forEach(q => { q.userAnswers = []; q.submitted = false; q.isCorrect = false; q.isPartial = false; });
      addMsg('bot', `üìù ${parsed.questions.length} questions are ready in Practice Workspace.`, 'quiz', parsed);
      session.activeStudyMsgIdx = session.messages.length - 1;
      renderChat();
      renderPracticePane();
      return;
    }

    // Coding
    if (cmdType === 'coding' && parsed && parsed.problems && parsed.problems.length > 0) {
      addMsg('bot', `üíª ${parsed.problems.length} coding problem(s) are ready in Practice Workspace.`, 'coding', parsed);
      session.activeStudyMsgIdx = session.messages.length - 1;
      state.stats.problems += parsed.problems.length;
      updateStatsUI();
      renderChat();
      renderPracticePane();
      return;
    }

    // Flashcards
    if (cmdType === 'flashcards' && parsed && parsed.cards && parsed.cards.length > 0) {
      addMsg('bot', `üÉè ${parsed.cards.length} flashcards are ready in Practice Workspace.`, 'flashcards', parsed);
      session.activeStudyMsgIdx = session.messages.length - 1;
      renderChat();
      renderPracticePane();
      return;
    }

    // Retry once
    if (retryCount < 1) {
      console.warn('JSON parse failed, retrying. Raw:', response.slice(0, 500));
      showTyping();
      return processAIRequest(userText, cmdType, isStructured, retryCount + 1);
    }
    console.error('JSON parse failed after retry:', response.slice(0, 500));
  }

  // Fallback: show as text
  addMsg('bot', response);
  appendMsgEl('bot', response);
}

function detectCommand(text) {
  const l = text.toLowerCase().trim();
  if (l.startsWith('/multiquiz')) return 'multiquiz';
  if (l.startsWith('/quiz')) return 'quiz';
  if (l.startsWith('/coding') || l.startsWith('/code') || l.startsWith('/problem')) return 'coding';
  if (l.startsWith('/flashcard')) return 'flashcards';
  if (l.startsWith('/explain')) return 'explain';
  if (l.startsWith('/summary') || l.startsWith('/summarize')) return 'summary';
  return null;
}

// ============================================================
// QUICK COMMANDS
// ============================================================
function quickCommand(cmd) {
  const input = document.getElementById('userInput');
  input.value = cmd + ' ';
  input.focus();
  closeSidebar();
}

function quickSend(text) {
  const input = document.getElementById('userInput');
  input.value = text;
  sendMessage();
}

// ============================================================
// UI UTILITIES
// ============================================================
function handleInputKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 200) + 'px';
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('active');
}

function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebarOverlay').classList.remove('active');
}

function showToast(message, type) {
  const toast = document.createElement('div');
  toast.className = `toast ${type || 'info'}`;
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 4000);
}

function updateStatsUI() {
  document.getElementById('statQuizzes').textContent = state.stats.quizzes;
  document.getElementById('statCorrect').textContent = state.stats.correct;
  document.getElementById('statWrong').textContent = state.stats.wrong;
  document.getElementById('statProblems').textContent = state.stats.problems;
}

// ============================================================
// SETTINGS
// ============================================================
function onLangChange() {
  state.language = document.getElementById('langSelect').value;
  document.getElementById('userInput').placeholder = t('placeholder');
  saveState();
}

function saveMaterial() {
  state.material = document.getElementById('materialInput').value;
  saveState();
}

// ============================================================
// EXPORT
// ============================================================
function exportSession() {
  const session = getCurrentSession();
  if (!session || session.messages.length === 0) { showToast('No session to export', 'info'); return; }

  let md = `# ${t('exportTitle')}\n## ${session.title.replace(/[<>&"]/g, '')}\n**Date:** ${new Date(session.created).toLocaleString()}\n\n---\n\n`;

  session.messages.forEach(msg => {
    if (msg.role === 'user') {
      md += `### üë§ You\n${msg.content}\n\n`;
    } else if (msg.type === 'quiz' && msg.data) {
      md += `### üìù Quiz (${msg.data.type === 'multi' ? 'Multi-Answer' : 'Single Answer'})\n`;
      msg.data.questions.forEach((q, i) => {
        md += `**Q${i + 1}.** ${q.question}\n`;
        q.options.forEach((o, j) => {
          const ic = msg.data.type === 'multi' ? (q.correctIndices || []).includes(j) : j === q.correctIndex;
          md += `${ic ? '  ‚úÖ' : '  ‚óªÔ∏è'} ${o}\n`;
        });
        if (q.explanation) md += `> **Explanation:** ${q.explanation}\n`;
        if (q.submitted) md += `> **Result:** ${q.isCorrect ? '‚úÖ Correct' : '‚ùå Incorrect'}\n`;
        md += '\n';
      });
    } else if (msg.type === 'coding' && msg.data) {
      (msg.data.problems || []).forEach(p => {
        md += `### üíª ${p.title} [${p.difficulty}]\n${p.description}\n`;
        if (p.examples) p.examples.forEach(ex => { md += `\n**Input:** \`${ex.input}\`  **Output:** \`${ex.output}\`\n`; });
        if (p.hint) md += `> **Hint:** ${p.hint}\n`;
        md += '\n';
      });
    } else if (msg.type === 'flashcards' && msg.data) {
      md += `### üÉè Flashcards\n`;
      (msg.data.cards || []).forEach((c, i) => { md += `${i + 1}. **${c.term}** ‚Äî ${c.definition}\n`; });
      md += '\n';
    } else if (msg.type === 'score' && msg.data) {
      md += `### üèÜ Score: ${msg.data.correct}/${msg.data.total} (${msg.data.percentage}%)\n\n`;
    } else if (msg.role === 'bot') {
      md += `### üéì AI Coach\n${msg.content}\n\n`;
    }
  });

  md += `---\n### Session Stats\n- Quizzes answered: ${state.stats.quizzes}\n- Correct: ${state.stats.correct}\n- Wrong: ${state.stats.wrong}\n- Coding problems: ${state.stats.problems}\n`;

  const blob = new Blob([md], { type: 'text/markdown' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `exam-coach-${session.id}.md`;
  a.click(); URL.revokeObjectURL(url);
  showToast('Session exported!', 'success');
}

// ============================================================
// INIT
// ============================================================
function init() {
  loadState();
  document.getElementById('langSelect').value = state.language || 'en';
  document.getElementById('materialInput').value = state.material || '';
  document.getElementById('userInput').placeholder = t('placeholder');
  updateStatsUI();
  renderSessionList();

  // Restore file info if we had an uploaded file
  if (state.uploadedFileName && state.material) {
    updateFileInfo(state.uploadedFileName, `‚úÖ ${state.material.length.toLocaleString()} chars`);
  }

  if (state.currentSessionId && getCurrentSession()) renderChat();
  renderPracticePane();
  document.getElementById('userInput').focus();
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
